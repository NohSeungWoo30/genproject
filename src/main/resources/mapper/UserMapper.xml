<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<!-- 예시 유저 맵퍼 -->
<mapper namespace="generationgap.co.kr.mapper.user.UserMapper">
    <resultMap id="userResultMap" type="generationgap.co.kr.domain.user.UserDTO">
        <id property="userIdx" column="user_idx"/>
        <result property="userId" column="user_id"/>
        <result property="provider" column="provider"/>
        <result property="userName" column="user_name"/>
        <result property="nickname" column="nickname"/>
        <result property="birthDate" column="birth_date"/>
        <result property="gender" column="gender"/>
        <result property="userCi" column="user_ci"/>
        <result property="passwordHash" column="password_hash"/>
        <result property="email" column="email"/>
        <result property="phone" column="phone"/>
        <result property="profileName" column="profile_name"/>
        <result property="introduction" column="introduction"/>
        <result property="signupDate" column="signup_date"/>
        <result property="userStatus" column="user_status"/>
        <result property="lastLoginAt" column="last_login_at"/>
        <result property="updateAt" column="update_at"/>
        <result property="ghost" column="ghost"/>

        <!--신고위해 추가한 컬럼 추가 ksm-->
        <result property="isSuspended" column="is_suspended"/>
        <result property="suspendUntil" column="suspend_until"/>
    </resultMap>



    <insert id="insertUser" parameterType="generationgap.co.kr.domain.user.UserDTO">
        INSERT INTO users (
        user_id, provider, user_name, nickname, birth_date, gender,
        user_ci, password_hash, email, phone, profile_name, introduction
        ) VALUES (
        #{userId}, #{provider}, #{userName}, #{nickname}, #{birthDate}, #{gender},
        #{userCi}, #{passwordHash}, #{email}, #{phone}, #{profileName, jdbcType=VARCHAR}, #{introduction}
        )
    </insert>

    <!--
        <select id="findByUserId" parameterType="string" resultType="generationgap.co.kr.domain.user.UserDTO">
    -->
    <select id="findByUserId" parameterType="string" resultMap="userResultMap">
        SELECT
        user_idx, user_id, provider, user_name, nickname, birth_date, gender,
        user_ci, password_hash, email, phone, profile_name, introduction,
        signup_date, user_status, last_login_at, update_at, ghost
        FROM users
        WHERE user_id = #{userId}
    </select>

    <update id="updateUserPassword" parameterType="generationgap.co.kr.domain.user.UserDTO">
        UPDATE users
        SET password_hash = #{passwordHash},
        update_at = SYSDATE <!--비밀번호 변경 시 업데이트 시간 기록 (Oracle)-->
        WHERE user_idx = #{userIdx}
    </update>


    <!-- 3일 정지 설정 ksm -->
    <update id="suspendUser">
        UPDATE users
        SET is_suspended = 1,
        suspend_until = SYSTIMESTAMP + NUMTODSINTERVAL(3, 'DAY')
        WHERE user_idx = #{userId}
    </update>

    <!--시간 지나면 자동으로 정지 해제 ksm-->
    <update id="releaseExpiredSuspensions">
        <![CDATA[
        UPDATE users
            SET is_suspended = 0,
            suspend_until = NULL
        WHERE is_suspended = 1
            AND suspend_until <= SYSTIMESTAMP
        ]]>
    </update>

    <!--확인용 ksm-->
    <select id="findSuspendCandidates" resultMap="userResultMap">
        <![CDATA[
        SELECT user_idx, user_id, is_suspended, suspend_until
        FROM users
        WHERE is_suspended = 1
        AND suspend_until <= SYSTIMESTAMP
        ]]>
    </select>

    <!-- idx로 정보가져오기 ksm-->
    <select id="findByUserIdx" resultMap="userResultMap">
        SELECT * FROM users WHERE user_idx = #{userIdx}
    </select>
</mapper>
