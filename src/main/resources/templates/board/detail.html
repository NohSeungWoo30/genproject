<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title th:text="${post.title}">ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°</title>

  <link rel="stylesheet" href="/css/vars.css" />
  <link rel="stylesheet" href="/css/boardstyle.css" />
  <link rel="stylesheet" href="/css/detail.css" />
  <link rel="stylesheet" href="/css/mainstyle.css" />

  <!--í† ìŠ¤íŠ¸(ìš°ì¸¡í•˜ë‹¨ ì‹¤ì‹œê°„ ì•Œë¦¼) ì¶”ê°€ ëª¨ë“  í˜ì´ì§€ì— ê¼­ ì¶”ê°€í•˜ê¸°-->
  <link rel="stylesheet" href="/css/toast.css" />
  <!--ì•Œë¦¼(ì¢…ëª¨ì–‘)ê¸°ëŠ¥ cssì¶”ê°€ ì•Œë¦¼ê¸°ëŠ¥ì´ í¬í•¨ë˜ëŠ” ëª¨ë“  ê³³ì— ì¶”ê°€í•˜ê¸°-->
  <link rel="stylesheet" href="/css/notify.css" />
  <!--ë¡œê·¸ì¸ ì„¸ì…˜ê´€ë ¨ ê³„ì† ì¶”ê°€í•˜ê¸°-->
  <th:block th:replace="fragments/user-session :: sessionScript"></th:block>

  <!--ì•Œë¦¼ ì•„ì´ì½˜ê´€ë ¨ ê³„ì† ì¶”ê°€í•˜ê¸°-->
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

  <!-- 1. í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬: SockJS, STOMP -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <!-- Lucide ì•„ì´ì½˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://unpkg.com/lucide@latest"></script>


</head>
<body>
<!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<header class="container-nav">
  <div class="nav-left">
    <a th:href="@{/main}"><img class="logo" src="/img/icons/Group 17.png" alt="M ë¡œê³ "></a>
  </div>

  <div class="nav-right" id="navRight">
    <a href="/user/login" class="login-link">ë¡œê·¸ì¸ã†íšŒì›ê°€ì…</a>
  </div>
</header>

<!--í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°”-->
<section class="bottom-nav-wrapper">
  <nav class="bottom-nav">
    <a href="#" class="bottom-link">ëª¨ì„ ìƒì„±</a>
    <a href="meeting-list.html" class="bottom-link">ëª¨ì„ ëª©ë¡</a>
    <a href="#" class="bottom-link">ìƒí’ˆ ëª©ë¡</a>
    <a th:href="@{/posts}" class="bottom-link">ììœ  ê²Œì‹œíŒ</a>
  </nav>
</section>

<div class="detail-container">

  <h1 class="post-title" th:text="${post.title}">ì œëª©</h1>

  <div class="detail-meta">
    <span>ì¹´í…Œê³ ë¦¬: <span th:text="${post.category}"></span></span>
    <span>ì‘ì„±ì: <span th:text="${post.authorName}"></span></span>

    <span>ì‘ì„±ì¼: <span th:text="${createdAtStr}"></span></span>

    <span th:if="${isEdited}" style="margin-left: 12px; color: gray;">
    (ìˆ˜ì •ë¨: <span th:text="${updatedAtStr}"></span>)
    </span>

    <span>ì¡°íšŒìˆ˜: <span th:text="${post.viewCount}"></span></span>
  </div>

  <div class="post-content">
    <div class="detail-content" th:text="${post.content}">ë‚´ìš©</div>

    <!-- ì²¨ë¶€ ì´ë¯¸ì§€ ì„¹ì…˜ -->
    <div class="detail-images-list" th:if="${attachments != null and #lists.size(attachments) > 0}">
      <div th:each="file : ${attachments}"
           th:if="${#strings.endsWith(file.originalName.toLowerCase(), '.png')
                or #strings.endsWith(file.originalName.toLowerCase(), '.jpg')
                or #strings.endsWith(file.originalName.toLowerCase(), '.jpeg')
                or #strings.endsWith(file.originalName.toLowerCase(), '.gif')}">
        <img th:src="@{|/uploads/${file.fileName}|}" alt="ì²¨ë¶€ ì´ë¯¸ì§€" />
      </div>
    </div>
  </div>



  <div class="detail-actions" style="display: flex; justify-content: space-between; align-items: center;">

    <div style="display: flex; gap: 8px; align-items: center;">
    <button type="button" class="btn-icon" title="ì¶”ì²œ" th:onclick="|likePost(${post.postIdx})|">
      <i data-lucide="heart"></i>
    </button>
    <span th:attr="id='like-count-' + ${post.postIdx}"
          th:text="${post.likeCount + 'ëª…ì´ ì¶”ì²œí–ˆì–´ìš”'}">0ëª…ì´ ì¶”ì²œí–ˆì–´ìš”</span>
    </div>

    <div style="display: flex; gap: 8px;">

    <th:block th:if="${#authentication.principal instanceof T(generationgap.co.kr.security.CustomUserDetails)
                 and post.authorIdx == #authentication.principal.userIdx}">
      <button class="btn-text" th:onclick="|location.href='/posts/${post.postIdx}/edit'|">ìˆ˜ì •</button>

    </th:block>

    <th:block th:if="${#authentication.authenticated}">
      <button class="btn-text" th:onclick="|openReportModal('POST', ${post.postIdx}, ${post.authorIdx}, 2)|">ì‹ ê³ </button>
    </th:block>

      <button class="btn-text" th:onclick="|deletePost(${post.postIdx})|">ì‚­ì œ</button>

    </div>
  </div>



  <div class="comments-section">
    <h3>ğŸ’¬ ëŒ“ê¸€</h3>
    <!-- âœ… ì›ëŒ“ê¸€ ë£¨í”„ -->
    <div th:each="parent : ${parentComments}" class="comment">
      <th:block th:if="${parent.isDeleted == 'Y'}">
        <span style="color: gray;">[ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤]</span>
      </th:block>

      <th:block th:unless="${parent.isDeleted == 'Y'}">
        <span class="author" th:text="${parent.authorNickname}">ì‘ì„±ì</span>
        <span th:id="'content-' + ${parent.commentIdx}" th:text="${parent.content}">ë‚´ìš©</span>
        <!--<span th:text="${parent.formattedDisplayTime}"></span>
        <span th:if="${parent.isEdited}" style="font-size: 12px; color: gray;">(ìˆ˜ì •ë¨)</span>-->
        <span th:id="'time-' + ${parent.commentIdx}" id="time-[[${parent.commentIdx}]]"
              th:text="${parent.formattedDisplayTime}"></span>
        <span th:if="${parent.isEdited}" class="edited-label" style="font-size: 12px; color: gray;"> (ìˆ˜ì •ë¨)</span>


        <div class="comment-actions" style="display: flex; gap: 6px; margin-top: 6px;">

        <!-- ë³¸ì¸ë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥ -->
        <th:block th:if="${#authentication.authenticated}">

          <button class="btn-text"
                  th:if="${#authentication.principal instanceof T(generationgap.co.kr.security.CustomUserDetails)
                      and parent.commenterIdx == #authentication.principal.userIdx}"
                  th:onclick="'startEdit(' + ${parent.commentIdx} + ')'">ìˆ˜ì •
          </button>

          <button class="btn-text"
                  th:if="${#authentication.principal instanceof T(generationgap.co.kr.security.CustomUserDetails)
                      and parent.commenterIdx == #authentication.principal.userIdx}"

                  th:onclick="'deleteComment(' + ${parent.commentIdx} + ')'">ì‚­ì œ
          </button>
        </th:block>

        <button class="btn-text"
                type="button"
                th:onclick="|openReportModal('COMMENT', ${parent.commentIdx}, ${parent.commenterIdx}, 3)|">ì‹ ê³ 
        </button>


          <!-- ëŒ“ê¸€ ë²„íŠ¼ (ì›ëŒ“ê¸€ë§Œ) -->
          <button class="btn-text"
                  th:if="${#authentication.authenticated}"
                  th:onclick="|showReplyForm(${parent.commentIdx})|">
            ë‹µê¸€
          </button>
        </div>


        <!-- ëŒ“ê¸€ ì…ë ¥í¼ -->
        <div th:id="'reply-form-' + ${parent.commentIdx}" class="reply-form" style="display:none;">
          <input type="text" th:id="'reply-content-' + ${parent.commentIdx}" placeholder="ë‹µê¸€ ì…ë ¥" />
          <button th:onclick="|submitReply(${post.postIdx}, ${parent.commentIdx})|">ë“±ë¡</button>
        </div>

        <!-- ìˆ˜ì • ì…ë ¥í¼ -->
        <div th:id="'edit-box-' + ${parent.commentIdx}" class="edit-form" style="display:none;">
          <input type="text" th:id="'edit-input-' + ${parent.commentIdx}" placeholder="ìˆ˜ì • ëŒ“ê¸€ ì…ë ¥" />
          <button th:onclick="'submitEdit(' + ${parent.commentIdx} + ')'">ì €ì¥</button>
        </div>

        <button class="btn-show-replies"
                th:if="${replyCounts != null and replyCounts[parent.commentIdx] != null and replyCounts[parent.commentIdx] > 0}"
                th:onclick="'toggleReplies(' + ${parent.commentIdx} + ', this)'">
          â–¼ ë‹µê¸€ <span th:text="${replyCounts[parent.commentIdx]}">0</span>ê°œ ë³´ê¸°
        </button>


      </th:block>

      <!-- âœ… ëŒ€ëŒ“ê¸€ ê·¸ë£¹í•‘ ë Œë”ë§ -->
      <div th:id="'replies-' + ${parent.commentIdx}" style="display: none;">
      <div th:each="reply : ${repliesMap[parent.commentIdx]}" class="comment reply">
        <th:block th:if="${reply.isDeleted == 'Y'}">
          <span style="color: gray;">[ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤]</span>
        </th:block>

        <th:block th:unless="${reply.isDeleted == 'Y'}">
          <span class="author" th:text="${reply.authorNickname}">ì‘ì„±ì</span>
          <span th:id="'content-' + ${reply.commentIdx}" th:text="${reply.content}">ë‚´ìš©</span>
          <!--<span th:text="${reply.formattedDisplayTime}"></span>
          <span th:if="${reply.isEdited}" style="font-size: 12px; color: gray;">(ìˆ˜ì •ë¨)</span>-->
          <span th:id="'time-' + ${reply.commentIdx}"
                th:text="${reply.formattedDisplayTime}"></span>
          <span th:if="${reply.isEdited}" class="edited-label" style="font-size: 12px; color: gray;"> (ìˆ˜ì •ë¨)</span>



        <div class="comment-actions" style="display: flex; gap: 6px; margin-top: 6px;">

          <th:block th:if="${#authentication.authenticated}">
            <button type="button" class="btn-text"
                    th:if="${#authentication.principal instanceof T(generationgap.co.kr.security.CustomUserDetails) and reply.commenterIdx == #authentication.principal.userIdx}"
                    th:onclick="'startEdit(' + ${reply.commentIdx} + ')'">ìˆ˜ì •
            </button>

            <button type="button" class="btn-text"
                    th:if="${#authentication.principal instanceof T(generationgap.co.kr.security.CustomUserDetails) and reply.commenterIdx == #authentication.principal.userIdx}"
                    th:onclick="'deleteComment(' + ${reply.commentIdx} + ')'">ì‚­ì œ
            </button>
          </th:block>

          <button type="button" class="btn-text"
                  th:onclick="|openReportModal('COMMENT', ${reply.commentIdx}, ${reply.commenterIdx}, 3)|">ì‹ ê³ 
          </button>
        </div>

          <!-- ëŒ€ëŒ“ê¸€ì—ëŠ” ëŒ“ê¸€ ë²„íŠ¼ X -->

          <!-- ìˆ˜ì • í¼ -->
          <div th:id="'edit-box-' + ${reply.commentIdx}" class="edit-form" style="display:none;">
            <input type="text" th:id="'edit-input-' + ${reply.commentIdx}" th:value="${reply.content}" />
            <button th:onclick="'submitEdit(' + ${reply.commentIdx} + ')'">ì €ì¥</button>
          </div>
        </th:block>
      </div>
      </div>

    </div>

    <!-- ìµœìƒìœ„ ëŒ“ê¸€ ì‘ì„± í¼ -->
    <div class="comment-form">
      <input type="text" id="new-comment-content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" />
      <button th:onclick="|submitReply(${post.postIdx}, null)|">ë“±ë¡</button>
    </div>
  </div>


  <div th:with="queryParams='?page=' + ${currentPage}
  + (${category != null and category != 'null'} ? '&category=' + ${category} : '')
  + (${sort != null and sort != 'null'} ? '&sort=' + ${sort} : '')
  + (${keyword != null and keyword != 'null'} ? '&keyword=' + ${keyword} : '')">

    <a th:href="@{'/posts' + ${queryParams}}" class="btn-back">
      â† ëª©ë¡ìœ¼ë¡œ
    </a>

  </div>

</div>

<input type="hidden" id="csrf-token" th:value="${_csrf != null ? _csrf.token : ''}" />
<script th:inline="javascript">

  const csrf = {
   token: /*[[${_csrf != null ? _csrf.token : ''}]]*/
 };


   // ğŸ‘ ì¢‹ì•„ìš” ì‹œì‘
   function likePost(postId) {
       if (!postId) {
         alert("postIdê°€ ì—†ìŠµë‹ˆë‹¤!");
         return;
       }

       fetch(`/posts/${postId}/like`, {
         method: 'POST'
       })
       .then(res => {
         if (!res.ok) {
           return res.text().then(html => {
             throw new Error("ì„œë²„ ì—ëŸ¬ (status " + res.status + ")");
           });
         }
         return res.json();
       })
       .then(data => {
         // ì‹¤íŒ¨í•œ ê²½ìš°: { status:"fail", message:"ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." }
         if (data.status === "fail") {
           alert(data.message);
           return;
         }
         // ì •ìƒ: { liked: true/false, likeCount: ìˆ«ì }
         const span = document.getElementById(`like-count-${postId}`);
         if (span) {
           span.textContent = `${data.likeCount}ëª…ì´ ì¶”ì²œí–ˆì–´ìš”`;
         }
         alert(data.liked ? "ì¶”ì²œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!" : "ì¶”ì²œì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤!");
       })
       .catch(err => {
         console.error(err);
         alert("ì¶”ì²œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n" + err.message);
       });
     } // ğŸ‘ ì¢‹ì•„ìš” ë

     //ì‚­ì œë²„íŠ¼

     function deletePost(postId) {
   if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

   fetch(`/posts/${postId}/delete`, {
     method: 'POST'
   })
   .then(res => {
     if (res.status === 403) {
       // ì‘ì„±ì ê¶Œí•œì´ ì—†ìœ¼ë©´ 403 â†’ alertë§Œ ë„ìš°ê³  ë
       return res.json()
         .catch(() => { throw new Error("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); })
         .then(obj => { throw new Error(obj.message || "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); });
     }
     if (!res.ok) {
       return res.text().then(html => {
         throw new Error("ì„œë²„ ì˜¤ë¥˜ (status: " + res.status + ")");
       });
     }
     // ì •ìƒ(200) â†’ ëª©ë¡ìœ¼ë¡œ ì´ë™
     window.location.href = '/posts';
   })
   .catch(err => {
     alert(err.message);
   });
 }//ì‚­ì œë²„íŠ¼ë

   // ğŸ’¬ ëŒ“ê¸€ ì‹œì‘
   function showReplyForm(commentId) {
  const replyForm = document.getElementById("reply-form-" + commentId);
  const editBox = document.getElementById("edit-box-" + commentId);

  // ìˆ˜ì • í¼ ë‹«ê¸°
  if (editBox && editBox.style.display !== 'none') {
    editBox.style.display = 'none';
  }

  // ë‹¤ë¥¸ ëŒ“ê¸€í¼ ë‹¤ ë‹«ê¸°
  document.querySelectorAll('[id^="reply-form-"]').forEach(el => {
    if (el.id !== 'reply-form-' + commentId) {
      el.style.display = 'none';
    }
  });

  // í˜„ì¬ ëŒ“ê¸€í¼ë§Œ í† ê¸€
  replyForm.style.display = (replyForm.style.display === 'none' || replyForm.style.display === '') ? 'block' : 'none';
}

   function submitReply(postIdx, parentCommentId) {
     let content;
     if (parentCommentId !== null) {
       content = document.getElementById("reply-content-" + parentCommentId).value;
     } else {
       content = document.getElementById("new-comment-content").value;
     }




     if (!content.trim()) {
       alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
       return;
     }

     fetch(`/posts/${postIdx}/comments`, {
   method: "POST",
   headers: { "Content-Type": "application/x-www-form-urlencoded" },
   body: `content=${encodeURIComponent(content)}&parentCommentId=${parentCommentId ?? ''}`
 })
 .then(res => res.text())  // ì—¬ê¸° ì¶”ê°€
 .then(text => {
   if (text === "ok") {
     alert("ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
     location.reload();
   } else {
     alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: " + text);
   }
 })
 .catch(err => {
   console.error("ì—ëŸ¬:", err);
   alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
 });
   } // ğŸ’¬ ëŒ“ê¸€ ë

   //ëŒ“ê¸€ ì‚­ì œ
   function deleteComment(commentIdx) {
     if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

     fetch(`/posts/comments/${commentIdx}/delete`, {
       method: 'POST'
     })
     .then(res => {
       if (res.status === 403) {
         // ì„œë²„ì—ì„œ 403 Forbidden ì‘ë‹µ ì‹œ â†’ Frontì—ì„œ alertë§Œ ë„ìš°ê³  ì¢…ë£Œ
         return res.json()
           .catch(() => { throw new Error("ëŒ“ê¸€ ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); })
           .then(obj => { throw new Error(obj.message || "ëŒ“ê¸€ ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); });
       }
       if (!res.ok) {
         // 400/500 ë“±ì˜ ë‹¤ë¥¸ ì˜¤ë¥˜
         return res.text().then(html => {
           throw new Error("ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì„œë²„ ì˜¤ë¥˜ (status: " + res.status + ")");
         });
       }
       // ì •ìƒ ì‚­ì œ(200) â†’ í˜ì´ì§€ ë¦¬ë¡œë“œ
       location.reload();
     })
     .catch(err => {
       alert(err.message);
     });
   }//ëŒ“ê¸€ ì‚­ì œ ë

   function startEdit(commentIdx) {
  // ìˆ˜ì • í¼ element
  const editBox = document.getElementById('edit-box-' + commentIdx);
  const replyForm = document.getElementById('reply-form-' + commentIdx);

  // ëŒ“ê¸€ í¼ì´ ì—´ë ¤ìˆë‹¤ë©´ ë‹«ê¸°
  if (replyForm && replyForm.style.display !== 'none') {
    replyForm.style.display = 'none';
  }

  // ë‹¤ë¥¸ ìˆ˜ì •í¼ ë‹¤ ë‹«ê¸°
  document.querySelectorAll('[id^="edit-box-"]').forEach(el => {
    if (el.id !== 'edit-box-' + commentIdx) {
      el.style.display = 'none';
    }
  });

  // í˜„ì¬ ìˆ˜ì •í¼ í† ê¸€
  editBox.style.display = (editBox.style.display === 'none' || editBox.style.display === '') ? 'block' : 'none';
}

   function submitEdit(commentIdx) {
     const content = document.getElementById('edit-input-' + commentIdx).value;

     fetch(`/posts/comments/${commentIdx}/edit`, {
       method: 'POST',
       headers: {
         'Content-Type': 'application/json',
         'X-CSRF-TOKEN': csrf.token

       },
       body: JSON.stringify({ content: content })
     })
     .then(res => {
       if (!res.ok) throw new Error("ìˆ˜ì • ì‹¤íŒ¨");
       return res.json();
     })
     .then(data => {
       // í™”ë©´ì— ëŒ“ê¸€ ë‚´ìš© ê°±ì‹ 
       document.getElementById('content-' + commentIdx).textContent = data.updatedContent;

       // ì‹œê°„ ê°±ì‹ 
        const timeSpan = document.getElementById('time-' + commentIdx);
        if (timeSpan) {
          // ì‹œê°„ ì—…ë°ì´íŠ¸
          timeSpan.textContent = data.formattedDisplayTime;

          // ê¸°ì¡´ (ìˆ˜ì •ë¨) span ì œê±°
          const existingEdited = timeSpan.parentNode.querySelector('.edited-label');
          if (existingEdited) existingEdited.remove();

          // (ìˆ˜ì •ë¨) ë°”ë¡œ ë’¤ì— ìƒˆë¡œ ë¶™ì´ê¸°
          if (data.isEdited) {
            const editedSpan = document.createElement('span');
            editedSpan.classList.add('edited-label');
            editedSpan.textContent = ' (ìˆ˜ì •ë¨)';
            editedSpan.style.fontSize = '12px';
            editedSpan.style.color = 'gray';
            timeSpan.insertAdjacentElement('afterend', editedSpan);
          }
        }

       // ìˆ˜ì • í¼ ë‹«ê¸°
       document.getElementById('edit-box-' + commentIdx).style.display = 'none';
     })
     .catch(err => alert(err.message));
   }


  //ê²Œì‹œê¸€ ì‹ ê³  ì‹œì‘
 function submitReport() {
  const reasonId = document.getElementById('report-reason').value;
  const comment = document.getElementById('report-comment').value;

console.log("ğŸš¨ ì‹ ê³  ë°ì´í„° í™•ì¸:", {
    entityType: currentTargetType,
    entityId: currentTargetId,
    reportCategoryId: Number(currentReportCategoryId),
    reportReasonId: Number(reasonId),
    reportedUserId: currentReportedUserId,
    reportComment: comment
  });

  fetch("/api/reports", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      //'X-CSRF-TOKEN' : csrf.token
    },
    body: JSON.stringify({
      entityType: currentTargetType,
      entityId: currentTargetId,
      reportCategoryId: Number(currentReportCategoryId),
      reportReasonId: Number(reasonId),
      reportedUserId: currentReportedUserId,
      reportComment: comment
    })
  })
  .then(async res => {
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.message || "ì‹ ê³  ì‹¤íŒ¨");
    }
    return res.json();
  })
  .then(() => {
    alert("ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
    closeReportModal();
  })
  .catch(err => alert("ì‹ ê³  ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message));
}

  //ëª¨ë‹¬

 let currentTargetType = null;
let currentTargetId = null;
let currentReportedUserId = null;
let currentReportCategoryId = null;

function openReportModal(type, id, userId, categoryId) {
  currentTargetType = type;
  currentTargetId = id;
  currentReportedUserId = userId;
  currentReportCategoryId = categoryId;
  document.getElementById('report-modal').style.display = 'block';
}

function closeReportModal() {
  document.getElementById('report-modal').style.display = 'none';
}


  function toggleReplies(parentId, btn) {
  const repliesDiv = document.getElementById('replies-' + parentId);
  if (repliesDiv.style.display === 'none') {
    repliesDiv.style.display = 'block';
    btn.textContent = 'â–² ë‹µê¸€ ìˆ¨ê¸°ê¸°';
  } else {
    repliesDiv.style.display = 'none';
    const count = repliesDiv.querySelectorAll('.comment.reply').length;
    btn.textContent = `â–¼ ë‹µê¸€ ${count}ê°œ ë³´ê¸°`;
  }
}
</script>

<!-- âœ… ì—¬ê¸°ì— ì‹ ê³  ëª¨ë‹¬ UI ë„£ê¸° -->
<div id="report-modal">
  <h3>ğŸš¨ ì‹ ê³ í•˜ê¸°</h3>
  <br>

  <label>
    <select id="report-reason">
      <option value="1">ìš•ì„¤/ë¹„ë°©/í˜ì˜¤ í‘œí˜„</option>
      <option value="2">ìŒë€/ì„ ì •ì ì¸ ì½˜í…ì¸ </option>
      <option value="3">ë„ë°°/ìŠ¤íŒ¸/ê´‘ê³ </option>
      <option value="4">ê°œì¸ ì •ë³´ ë…¸ì¶œ</option>
      <option value="5">ì‚¬ì¹­/í—ˆìœ„ ì •ë³´</option>
      <option value="6">ë¶€ì ì ˆí•œ ëª¨ì„/ê²Œì‹œê¸€ ë‚´ìš©</option>
      <option value="8">ê¸°íƒ€</option>
    </select>
  </label><br/><br/>

  <textarea id="report-comment" placeholder="ì‹ ê³  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" rows="4" cols="40"></textarea><br/><br/>


  <div class="modal-button-group">
    <button onclick="submitReport()">ì‹ ê³  ì œì¶œ</button>
    <button onclick="closeReportModal()">âŒ ë‹«ê¸°</button>
  </div>

</div>

<script>
  lucide.createIcons();
</script>


<!--ê¼­ notify.jsë‚˜ notification.js ë³´ë‹¤ ìœ„ì—-->
<th:block th:replace="fragments/notification-templates :: notiTemplates"></th:block>

<script src="/js/notify.js" defer></script>
<script src="/js/notification.js" defer></script>
</body>
</html>