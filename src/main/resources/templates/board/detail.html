<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${post.title}">제목</title>

  <style>
    .comment {
      margin-bottom: 10px;
      padding-left: 10px;
      border-left: 2px solid #ccc;
    }
    .reply {
      margin-left: 20px;
      border-color: #aaa;
    }
    .author {
      font-weight: bold;
    }
  </style>
</head>

<body>
<h2 th:text="${post.title}">제목</h2>

<p><b>카테고리:</b> <span th:text="${post.category}"></span></p>
<p><b>작성자:</b> <span th:text="${post.authorName}"></span></p>
<p><b>작성일:</b> <span th:text="${#dates.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span></p>

<hr/>
<div th:text="${post.content}">내용</div>

<br/>
<!-- 📎 첨부파일 표시 영역 추가 -->
<div th:if="${attachments != null and #lists.size(attachments) > 0}">
  <h4>📎 첨부파일</h4>
  <ul>
    <li th:each="file : ${attachments}">
      <!-- ✅ 이미지 파일인 경우 → 미리보기 표시 -->
      <div th:if="${#strings.endsWith(file.originalName.toLowerCase(), '.png')
                or #strings.endsWith(file.originalName.toLowerCase(), '.jpg')
                or #strings.endsWith(file.originalName.toLowerCase(), '.jpeg')
                or #strings.endsWith(file.originalName.toLowerCase(), '.gif')}">
        <img th:src="@{|/uploads/${file.fileName}|}" alt="첨부 이미지" style="max-width:300px;" />
      </div>
    </li>
  </ul>
</div>

<hr/>

<button
        type="button"
        th:onclick="|likePost(${post.postIdx})|">
  ❤️ 추천
</button>
<span
        th:attr="id='like-count-' + ${post.postIdx}"
        th:text="${post.likeCount}">
    0
  </span>

<!-- 수정 버튼 --><!-- 본인 글일 때만 노출 -->

<th:block th:if="${#authentication.authenticated}">
  <a th:if="${#authentication.principal instanceof T(generationgap.co.kr.security.CustomUserDetails) and post.authorIdx == #authentication.principal.userIdx}"
     th:href="@{'/posts/' + ${post.postIdx} + '/edit'}">✏ 수정</a>
</th:block>

<!-- 삭제 버튼 -->
<button type="button" th:onclick="|deletePost(${post.postIdx})|">
  🗑 삭제
</button>

<hr/>

<h3>💬 댓글</h3>


<!-- ✅ 댓글 목록 -->
<div th:each="comment : ${comments}">
  <div class="comment" th:classappend="${comment.parentCommentId != null} ? 'reply'">

    <!-- 🧾 삭제된 댓글 표시 -->
    <th:block th:if="${comment.isDeleted == 'Y'}">
      <span style="color: gray;">[삭제된 댓글입니다]</span>
    </th:block>

    <!-- ✅ 살아있는 댓글일 경우 -->
    <th:block th:unless="${comment.isDeleted == 'Y'}">
      <!-- 작성자 닉네임 -->
      <span class="author" th:text="${comment.authorNickname}">작성자</span>

      <!-- 댓글 본문 -->
      <span th:id="'content-' + ${comment.commentIdx}"
            th:text="${comment.content}">댓글내용</span>

      <!-- ✏ 수정 버튼: 본인만 -->
      <th:block th:if="${#authentication.authenticated}">
        <button th:if="${#authentication.principal instanceof T(generationgap.co.kr.security.CustomUserDetails)
                     and comment.commenterIdx == #authentication.principal.userIdx}"
                th:onclick="'startEdit(' + ${comment.commentIdx} + ')'">
          수정
        </button>

        <!-- 🗑 삭제 버튼: 본인만 -->
        <button th:if="${#authentication.principal instanceof T(generationgap.co.kr.security.CustomUserDetails)
                     and comment.commenterIdx == #authentication.principal.userIdx}"
                th:onclick="'deleteComment(' + ${comment.commentIdx} + ')'">
          🗑 삭제
        </button>
      </th:block>

      <!-- 💬 대댓글 버튼 (모든 로그인 유저) -->
      <button th:if="${#authentication.authenticated}"
              th:onclick="|showReplyForm(${comment.commentIdx})|">
        댓글
      </button>

      <!-- 📝 수정 입력폼 -->
      <div th:id="'edit-box-' + ${comment.commentIdx}" style="display:none; margin-top:5px;">
        <input type="text" th:id="'edit-input-' + ${comment.commentIdx}"
               th:value="${comment.content}" />
        <button th:onclick="'submitEdit(' + ${comment.commentIdx} + ')'">저장</button>
      </div>

      <!-- 💬 대댓글 입력폼 -->
      <div th:id="'reply-form-' + ${comment.commentIdx}" style="display:none; margin-top: 5px;">
        <input type="text" th:id="'reply-content-' + ${comment.commentIdx}" placeholder="답글 입력" />
        <button th:onclick="|submitReply(${post.postIdx}, ${comment.commentIdx})|">등록</button>
      </div>
    </th:block>
  </div>
</div>

<!-- ✅ 최상위 댓글 입력 폼 -->
<div class="comment-box">
  <input type="text" id="new-comment-content" placeholder="댓글을 입력하세요" style="width:300px;" />
  <button th:onclick="|submitReply(${post.postIdx}, null)|">등록</button>
</div>



<input type="hidden" id="csrf-token" th:value="${_csrf != null ? _csrf.token : ''}" />




<a th:href="@{/posts(page=${currentPage})}">← 목록으로</a>

<script th:inline="javascript">

  const csrf = {
   token: /*[[${_csrf != null ? _csrf.token : ''}]]*/
 };


   // 👍 좋아요 시작
   function likePost(postId) {
       if (!postId) {
         alert("postId가 없습니다!");
         return;
       }

       fetch(`/posts/${postId}/like`, {
         method: 'POST'
       })
       .then(res => {
         if (!res.ok) {
           return res.text().then(html => {
             throw new Error("서버 에러 (status " + res.status + ")");
           });
         }
         return res.json();
       })
       .then(data => {
         // 실패한 경우: { status:"fail", message:"로그인이 필요합니다." }
         if (data.status === "fail") {
           alert(data.message);
           return;
         }
         // 정상: { liked: true/false, likeCount: 숫자 }
         const span = document.getElementById(`like-count-${postId}`);
         if (span) {
           span.textContent = data.likeCount;
         }
         alert(data.liked ? "추천이 완료되었습니다!" : "추천이 취소되었습니다!");
       })
       .catch(err => {
         console.error(err);
         alert("추천 처리 중 오류 발생:\n" + err.message);
       });
     } // 👍 좋아요 끝

     //삭제버튼

     function deletePost(postId) {
   if (!confirm("정말 삭제하시겠습니까?")) return;

   fetch(`/posts/comments/${postId}/delete`, {
     method: 'POST'
   })
   .then(res => {
     if (res.status === 403) {
       // 작성자 권한이 없으면 403 → alert만 띄우고 끝
       return res.json()
         .catch(() => { throw new Error("권한이 없습니다."); })
         .then(obj => { throw new Error(obj.message || "권한이 없습니다."); });
     }
     if (!res.ok) {
       return res.text().then(html => {
         throw new Error("서버 오류 (status: " + res.status + ")");
       });
     }
     // 정상(200) → 목록으로 이동
     window.location.href = '/posts';
   })
   .catch(err => {
     alert(err.message);
   });
 }//삭제버튼끝

   // 💬 댓글 시작
   function showReplyForm(commentId) {
       console.log("💬 대댓글 입력 폼 열기: reply-form-" + commentId);

  const form = document.getElementById("reply-form-" + commentId);
  if (!form) {
    console.error("답글 폼이 존재하지 않습니다: reply-form-" + commentId);
    return;
  }
  form.style.display = (form.style.display === "none") ? "block" : "none";
}

   function submitReply(postIdx, parentCommentId) {
     let content;
     if (parentCommentId !== null) {
       content = document.getElementById("reply-content-" + parentCommentId).value;
     } else {
       content = document.getElementById("new-comment-content").value;
     }




     if (!content.trim()) {
       alert("내용을 입력하세요.");
       return;
     }

     fetch(`/posts/${postIdx}/comments`, {
   method: "POST",
   headers: { "Content-Type": "application/x-www-form-urlencoded" },
   body: `content=${encodeURIComponent(content)}&parentCommentId=${parentCommentId ?? ''}`
 })
 .then(res => res.text())  // 여기 추가
 .then(text => {
   if (text === "ok") {
     alert("댓글이 등록되었습니다.");
     location.reload();
   } else {
     alert("댓글 등록 실패: " + text);
   }
 })
 .catch(err => {
   console.error("에러:", err);
   alert("요청 중 오류 발생");
 });
   } // 💬 댓글 끝

   //댓글 삭제
   function deleteComment(commentIdx) {
     if (!confirm("댓글을 삭제하시겠습니까?")) return;

     fetch(`/posts/comments/${commentIdx}/delete`, {
       method: 'POST'
     })
     .then(res => {
       if (res.status === 403) {
         // 서버에서 403 Forbidden 응답 시 → Front에서 alert만 띄우고 종료
         return res.json()
           .catch(() => { throw new Error("댓글 삭제 권한이 없습니다."); })
           .then(obj => { throw new Error(obj.message || "댓글 삭제 권한이 없습니다."); });
       }
       if (!res.ok) {
         // 400/500 등의 다른 오류
         return res.text().then(html => {
           throw new Error("댓글 삭제 중 서버 오류 (status: " + res.status + ")");
         });
       }
       // 정상 삭제(200) → 페이지 리로드
       location.reload();
     })
     .catch(err => {
       alert(err.message);
     });
   }//댓글 삭제 끝

   function startEdit(commentIdx) {
     document.getElementById('edit-box-' + commentIdx).style.display = 'block';
   }

   function submitEdit(commentIdx) {
     const content = document.getElementById('edit-input-' + commentIdx).value;

     fetch(`/posts/comments/${commentIdx}/edit`, {
       method: 'POST',
       headers: {
         'Content-Type': 'application/json',
         'X-CSRF-TOKEN': csrf.token

       },
       body: JSON.stringify({ content: content })
     })
     .then(res => {
       if (!res.ok) throw new Error("수정 실패");
       return res.json();
     })
     .then(data => {
       // 화면에 댓글 내용 갱신
       document.getElementById('content-' + commentIdx).textContent = data.updatedContent;
       document.getElementById('edit-box-' + commentIdx).style.display = 'none';
     })
     .catch(err => alert(err.message));
   }
</script>
</body>
</html>
