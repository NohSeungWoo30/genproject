<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${post.title}">ì œëª©</title>

  <style>
    .comment {
      margin-bottom: 10px;
      padding-left: 10px;
      border-left: 2px solid #ccc;
    }
    .reply {
      margin-left: 20px;
      border-color: #aaa;
    }
    .author {
      font-weight: bold;
    }
  </style>
</head>

<body>
<h2 th:text="${post.title}">ì œëª©</h2>

<p><b>ì¹´í…Œê³ ë¦¬:</b> <span th:text="${post.category}"></span></p>
<p><b>ì‘ì„±ì:</b> <span th:text="${post.authorName}"></span></p>
<p><b>ì‘ì„±ì¼:</b> <span th:text="${#dates.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span></p>

<hr/>
<div th:text="${post.content}">ë‚´ìš©</div>

<br/>
<!-- ğŸ“ ì²¨ë¶€íŒŒì¼ í‘œì‹œ ì˜ì—­ ì¶”ê°€ -->
<div th:if="${attachments != null and #lists.size(attachments) > 0}">
  <h4>ğŸ“ ì²¨ë¶€íŒŒì¼</h4>
  <ul>
    <li th:each="file : ${attachments}">
      <!-- âœ… ì´ë¯¸ì§€ íŒŒì¼ì¸ ê²½ìš° â†’ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ -->
      <div th:if="${#strings.endsWith(file.originalName.toLowerCase(), '.png')
                or #strings.endsWith(file.originalName.toLowerCase(), '.jpg')
                or #strings.endsWith(file.originalName.toLowerCase(), '.jpeg')
                or #strings.endsWith(file.originalName.toLowerCase(), '.gif')}">
        <img th:src="@{|/uploads/${file.fileName}|}" alt="ì²¨ë¶€ ì´ë¯¸ì§€" style="max-width:300px;" />
      </div>
    </li>
  </ul>
</div>

<hr/>

<button
        type="button"
        th:onclick="|likePost(${post.postIdx})|">
  â¤ï¸ ì¶”ì²œ
</button>
<span
        th:attr="id='like-count-' + ${post.postIdx}"
        th:text="${post.likeCount}">
    0
  </span>

<!-- ìˆ˜ì • ë²„íŠ¼ --><!-- ë³¸ì¸ ê¸€ì¼ ë•Œë§Œ ë…¸ì¶œ -->

<th:block th:if="${#authentication.authenticated}">
  <a th:if="${#authentication.principal instanceof T(generationgap.co.kr.security.CustomUserDetails) and post.authorIdx == #authentication.principal.userIdx}"
     th:href="@{'/posts/' + ${post.postIdx} + '/edit'}">âœ ìˆ˜ì •</a>
</th:block>

<!-- ì‚­ì œ ë²„íŠ¼ -->
<button type="button" th:onclick="|deletePost(${post.postIdx})|">
  ğŸ—‘ ì‚­ì œ
</button>

<hr/>

<h3>ğŸ’¬ ëŒ“ê¸€</h3>


<!-- âœ… ëŒ“ê¸€ ëª©ë¡ -->
<div th:each="comment : ${comments}">
  <div class="comment" th:classappend="${comment.parentCommentId != null} ? 'reply'">

    <!-- ğŸ§¾ ì‚­ì œëœ ëŒ“ê¸€ í‘œì‹œ -->
    <th:block th:if="${comment.isDeleted == 'Y'}">
      <span style="color: gray;">[ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤]</span>
    </th:block>

    <!-- âœ… ì‚´ì•„ìˆëŠ” ëŒ“ê¸€ì¼ ê²½ìš° -->
    <th:block th:unless="${comment.isDeleted == 'Y'}">
      <!-- ì‘ì„±ì ë‹‰ë„¤ì„ -->
      <span class="author" th:text="${comment.authorNickname}">ì‘ì„±ì</span>

      <!-- ëŒ“ê¸€ ë³¸ë¬¸ -->
      <span th:id="'content-' + ${comment.commentIdx}"
            th:text="${comment.content}">ëŒ“ê¸€ë‚´ìš©</span>

      <!-- âœ ìˆ˜ì • ë²„íŠ¼: ë³¸ì¸ë§Œ -->
      <th:block th:if="${#authentication.authenticated}">
        <button th:if="${#authentication.principal instanceof T(generationgap.co.kr.security.CustomUserDetails)
                     and comment.commenterIdx == #authentication.principal.userIdx}"
                th:onclick="'startEdit(' + ${comment.commentIdx} + ')'">
          ìˆ˜ì •
        </button>

        <!-- ğŸ—‘ ì‚­ì œ ë²„íŠ¼: ë³¸ì¸ë§Œ -->
        <button th:if="${#authentication.principal instanceof T(generationgap.co.kr.security.CustomUserDetails)
                     and comment.commenterIdx == #authentication.principal.userIdx}"
                th:onclick="'deleteComment(' + ${comment.commentIdx} + ')'">
          ğŸ—‘ ì‚­ì œ
        </button>
      </th:block>

      <!-- ğŸ’¬ ëŒ€ëŒ“ê¸€ ë²„íŠ¼ (ëª¨ë“  ë¡œê·¸ì¸ ìœ ì €) -->
      <button th:if="${#authentication.authenticated}"
              th:onclick="|showReplyForm(${comment.commentIdx})|">
        ëŒ“ê¸€
      </button>

      <!-- ğŸ“ ìˆ˜ì • ì…ë ¥í¼ -->
      <div th:id="'edit-box-' + ${comment.commentIdx}" style="display:none; margin-top:5px;">
        <input type="text" th:id="'edit-input-' + ${comment.commentIdx}"
               th:value="${comment.content}" />
        <button th:onclick="'submitEdit(' + ${comment.commentIdx} + ')'">ì €ì¥</button>
      </div>

      <!-- ğŸ’¬ ëŒ€ëŒ“ê¸€ ì…ë ¥í¼ -->
      <div th:id="'reply-form-' + ${comment.commentIdx}" style="display:none; margin-top: 5px;">
        <input type="text" th:id="'reply-content-' + ${comment.commentIdx}" placeholder="ë‹µê¸€ ì…ë ¥" />
        <button th:onclick="|submitReply(${post.postIdx}, ${comment.commentIdx})|">ë“±ë¡</button>
      </div>
    </th:block>
  </div>
</div>

<!-- âœ… ìµœìƒìœ„ ëŒ“ê¸€ ì…ë ¥ í¼ -->
<div class="comment-box">
  <input type="text" id="new-comment-content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:300px;" />
  <button th:onclick="|submitReply(${post.postIdx}, null)|">ë“±ë¡</button>
</div>



<input type="hidden" id="csrf-token" th:value="${_csrf != null ? _csrf.token : ''}" />




<a th:href="@{/posts(page=${currentPage})}">â† ëª©ë¡ìœ¼ë¡œ</a>

<script th:inline="javascript">

  const csrf = {
   token: /*[[${_csrf != null ? _csrf.token : ''}]]*/
 };


   // ğŸ‘ ì¢‹ì•„ìš” ì‹œì‘
   function likePost(postId) {
       if (!postId) {
         alert("postIdê°€ ì—†ìŠµë‹ˆë‹¤!");
         return;
       }

       fetch(`/posts/${postId}/like`, {
         method: 'POST'
       })
       .then(res => {
         if (!res.ok) {
           return res.text().then(html => {
             throw new Error("ì„œë²„ ì—ëŸ¬ (status " + res.status + ")");
           });
         }
         return res.json();
       })
       .then(data => {
         // ì‹¤íŒ¨í•œ ê²½ìš°: { status:"fail", message:"ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." }
         if (data.status === "fail") {
           alert(data.message);
           return;
         }
         // ì •ìƒ: { liked: true/false, likeCount: ìˆ«ì }
         const span = document.getElementById(`like-count-${postId}`);
         if (span) {
           span.textContent = data.likeCount;
         }
         alert(data.liked ? "ì¶”ì²œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!" : "ì¶”ì²œì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤!");
       })
       .catch(err => {
         console.error(err);
         alert("ì¶”ì²œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n" + err.message);
       });
     } // ğŸ‘ ì¢‹ì•„ìš” ë

     //ì‚­ì œë²„íŠ¼

     function deletePost(postId) {
   if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

   fetch(`/posts/comments/${postId}/delete`, {
     method: 'POST'
   })
   .then(res => {
     if (res.status === 403) {
       // ì‘ì„±ì ê¶Œí•œì´ ì—†ìœ¼ë©´ 403 â†’ alertë§Œ ë„ìš°ê³  ë
       return res.json()
         .catch(() => { throw new Error("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); })
         .then(obj => { throw new Error(obj.message || "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); });
     }
     if (!res.ok) {
       return res.text().then(html => {
         throw new Error("ì„œë²„ ì˜¤ë¥˜ (status: " + res.status + ")");
       });
     }
     // ì •ìƒ(200) â†’ ëª©ë¡ìœ¼ë¡œ ì´ë™
     window.location.href = '/posts';
   })
   .catch(err => {
     alert(err.message);
   });
 }//ì‚­ì œë²„íŠ¼ë

   // ğŸ’¬ ëŒ“ê¸€ ì‹œì‘
   function showReplyForm(commentId) {
       console.log("ğŸ’¬ ëŒ€ëŒ“ê¸€ ì…ë ¥ í¼ ì—´ê¸°: reply-form-" + commentId);

  const form = document.getElementById("reply-form-" + commentId);
  if (!form) {
    console.error("ë‹µê¸€ í¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: reply-form-" + commentId);
    return;
  }
  form.style.display = (form.style.display === "none") ? "block" : "none";
}

   function submitReply(postIdx, parentCommentId) {
     let content;
     if (parentCommentId !== null) {
       content = document.getElementById("reply-content-" + parentCommentId).value;
     } else {
       content = document.getElementById("new-comment-content").value;
     }




     if (!content.trim()) {
       alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
       return;
     }

     fetch(`/posts/${postIdx}/comments`, {
   method: "POST",
   headers: { "Content-Type": "application/x-www-form-urlencoded" },
   body: `content=${encodeURIComponent(content)}&parentCommentId=${parentCommentId ?? ''}`
 })
 .then(res => res.text())  // ì—¬ê¸° ì¶”ê°€
 .then(text => {
   if (text === "ok") {
     alert("ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
     location.reload();
   } else {
     alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: " + text);
   }
 })
 .catch(err => {
   console.error("ì—ëŸ¬:", err);
   alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
 });
   } // ğŸ’¬ ëŒ“ê¸€ ë

   //ëŒ“ê¸€ ì‚­ì œ
   function deleteComment(commentIdx) {
     if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

     fetch(`/posts/comments/${commentIdx}/delete`, {
       method: 'POST'
     })
     .then(res => {
       if (res.status === 403) {
         // ì„œë²„ì—ì„œ 403 Forbidden ì‘ë‹µ ì‹œ â†’ Frontì—ì„œ alertë§Œ ë„ìš°ê³  ì¢…ë£Œ
         return res.json()
           .catch(() => { throw new Error("ëŒ“ê¸€ ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); })
           .then(obj => { throw new Error(obj.message || "ëŒ“ê¸€ ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); });
       }
       if (!res.ok) {
         // 400/500 ë“±ì˜ ë‹¤ë¥¸ ì˜¤ë¥˜
         return res.text().then(html => {
           throw new Error("ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì„œë²„ ì˜¤ë¥˜ (status: " + res.status + ")");
         });
       }
       // ì •ìƒ ì‚­ì œ(200) â†’ í˜ì´ì§€ ë¦¬ë¡œë“œ
       location.reload();
     })
     .catch(err => {
       alert(err.message);
     });
   }//ëŒ“ê¸€ ì‚­ì œ ë

   function startEdit(commentIdx) {
     document.getElementById('edit-box-' + commentIdx).style.display = 'block';
   }

   function submitEdit(commentIdx) {
     const content = document.getElementById('edit-input-' + commentIdx).value;

     fetch(`/posts/comments/${commentIdx}/edit`, {
       method: 'POST',
       headers: {
         'Content-Type': 'application/json',
         'X-CSRF-TOKEN': csrf.token

       },
       body: JSON.stringify({ content: content })
     })
     .then(res => {
       if (!res.ok) throw new Error("ìˆ˜ì • ì‹¤íŒ¨");
       return res.json();
     })
     .then(data => {
       // í™”ë©´ì— ëŒ“ê¸€ ë‚´ìš© ê°±ì‹ 
       document.getElementById('content-' + commentIdx).textContent = data.updatedContent;
       document.getElementById('edit-box-' + commentIdx).style.display = 'none';
     })
     .catch(err => alert(err.message));
   }
</script>
</body>
</html>
