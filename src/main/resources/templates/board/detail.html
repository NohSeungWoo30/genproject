<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${post.title}">ì œëª©</title>
  <style>
    .comment {
      margin-bottom: 10px;
      padding-left: 10px;
      border-left: 2px solid #ccc;
    }
    .reply {
      margin-left: 20px;
      border-color: #aaa;
    }
    .author {
      font-weight: bold;
    }
  </style>
</head>

<body>
<h2 th:text="${post.title}">ì œëª©</h2>

<p><b>ì¹´í…Œê³ ë¦¬:</b> <span th:text="${post.category}"></span></p>
<p><b>ì‘ì„±ì:</b> <span th:text="${post.authorName}"></span></p>
<p><b>ì‘ì„±ì¼:</b> <span th:text="${#dates.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span></p>

<hr/>
<div th:text="${post.content}">ë‚´ìš©</div>

<br/>
<!-- ğŸ“ ì²¨ë¶€íŒŒì¼ í‘œì‹œ ì˜ì—­ ì¶”ê°€ -->
<div th:if="${attachments != null and #lists.size(attachments) > 0}">
  <h4>ğŸ“ ì²¨ë¶€íŒŒì¼</h4>
  <ul>
    <li th:each="file : ${attachments}">
      <!-- âœ… ì´ë¯¸ì§€ íŒŒì¼ì¸ ê²½ìš° â†’ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ -->
      <div th:if="${#strings.endsWith(file.originalName.toLowerCase(), '.png')
                or #strings.endsWith(file.originalName.toLowerCase(), '.jpg')
                or #strings.endsWith(file.originalName.toLowerCase(), '.jpeg')
                or #strings.endsWith(file.originalName.toLowerCase(), '.gif')}">
        <img th:src="@{|/uploads/${file.fileName}|}" alt="ì²¨ë¶€ ì´ë¯¸ì§€" style="max-width:300px;" />
      </div>
    </li>
  </ul>
</div>

<hr/>

<button th:onclick="|likePost(${post.postIdx})|">ğŸ‘ ì¶”ì²œ</button>
<span id="like-count" th:text="${post.likeCount}">0</span>

<form th:action="@{'/posts/' + ${post.postIdx} + '/delete'}" method="post"
      onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
  <button type="submit">ğŸ—‘ ì‚­ì œ</button>
</form>

<hr/>

<h3>ğŸ’¬ ëŒ“ê¸€</h3>


<!-- âœ… ëŒ“ê¸€ ëª©ë¡ -->
<div th:each="comment : ${comments}">
  <div class="comment" th:classappend="${comment.parentCommentId != null} ? 'reply'">
    <span class="author" th:text="${comment.authorNickname}">ì‘ì„±ì</span>

    <!-- ğŸ”¥ ì‚­ì œ ì—¬ë¶€ì— ë”°ë¼ ì¶œë ¥ ë‹¤ë¥´ê²Œ -->
    <span th:if="${comment.isDeleted != 'Y'}" th:text="${comment.content}">ë‚´ìš©</span>
    <span th:if="${comment.isDeleted == 'Y'}" style="color:gray;"><i>ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤</i></span>

    <!-- ğŸ”˜ ì‚­ì œë˜ì§€ ì•Šì€ ëŒ“ê¸€ë§Œ ë²„íŠ¼ ë…¸ì¶œ -->
    <div th:if="${comment.isDeleted != 'Y'}">
      <div th:if="${comment.parentCommentId == null}">
        <button th:onclick="|showReplyForm(${comment.commentIdx})|">ë‹µê¸€</button>
        <button th:onclick="|deleteComment(${comment.commentIdx})|">ì‚­ì œ</button>
      </div>
      <div th:if="${comment.parentCommentId != null}">
        <button th:onclick="|deleteComment(${comment.commentIdx})|">ì‚­ì œ</button>
      </div>
    </div>

    <!-- ëŒ€ëŒ“ê¸€ ì…ë ¥í¼ (ì›ëŒ“ê¸€ë§Œ) -->
    <div th:if="${comment.parentCommentId == null}"
         th:id="'reply-form-' + ${comment.commentIdx}"
         style="display:none;">
      <input type="text" th:id="'reply-content-' + ${comment.commentIdx}" placeholder="ë‹µê¸€ ì…ë ¥" />
      <button th:onclick="|submitReply(${post.postIdx}, ${comment.commentIdx})|">ë“±ë¡</button>
    </div>
  </div>
</div>

<!-- âœ… ìµœìƒìœ„ ëŒ“ê¸€ ì…ë ¥ í¼ -->
<div class="comment-box">
  <input type="text" id="new-comment-content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:300px;" />
  <button th:onclick="|submitReply(${post.postIdx}, null)|">ë“±ë¡</button>
</div>





<a th:href="@{/posts(page=${currentPage})}">â† ëª©ë¡ìœ¼ë¡œ</a>

<script>
  // ğŸ‘ ì¢‹ì•„ìš” ì‹œì‘
  function likePost(postIdx) {
    fetch(`/posts/${postIdx}/like`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        document.getElementById("like-count").innerText = data.likeCount;
        alert(data.liked ? "ì¶”ì²œë˜ì—ˆìŠµë‹ˆë‹¤!" : "ì¶”ì²œì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      })
      .catch(err => {
        console.error("ì˜¤ë¥˜ ë°œìƒ:", err);
        alert("ìš”ì²­ ì‹¤íŒ¨");
      });
  } // ğŸ‘ ì¢‹ì•„ìš” ë

  // ğŸ’¬ ëŒ“ê¸€ ì‹œì‘
  function showReplyForm(commentId) {
    const form = document.getElementById("reply-form-" + commentId);
    form.style.display = (form.style.display === "none") ? "block" : "none";
  }

  function submitReply(postIdx, parentCommentId) {
    let content;
    if (parentCommentId !== null) {
      content = document.getElementById("reply-content-" + parentCommentId).value;
    } else {
      content = document.getElementById("new-comment-content").value;
    }

    if (!content.trim()) {
      alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    fetch(`/posts/${postIdx}/comments`, {
  method: "POST",
  headers: { "Content-Type": "application/x-www-form-urlencoded" },
  body: `content=${encodeURIComponent(content)}&parentCommentId=${parentCommentId ?? ''}`
})
.then(res => res.text())  // ì—¬ê¸° ì¶”ê°€
.then(text => {
  if (text === "ok") {
    alert("ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
    location.reload();
  } else {
    alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: " + text);
  }
})
.catch(err => {
  console.error("ì—ëŸ¬:", err);
  alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
});
  } // ğŸ’¬ ëŒ“ê¸€ ë

  //ëŒ“ê¸€ ì‚­ì œ
  function deleteComment(commentIdx) {
  if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  fetch(`/posts/comments/${commentIdx}/delete`, {
    method: 'POST'
  })
  .then(res => {
    if (res.ok) {
      location.reload();
    } else {
      alert("ì‚­ì œ ì‹¤íŒ¨");
    }
  })
  .catch(err => {
    console.error("ì—ëŸ¬ ë°œìƒ:", err);
    alert("ì˜¤ë¥˜ ë°œìƒ");
  });
}//ëŒ“ê¸€ ì‚­ì œ ë
</script>
</body>
</html>
