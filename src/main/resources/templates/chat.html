<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ëª¨ì„ ì±„íŒ…ë°©</title>
    <style>
        #context-menu {
          display: none;
          position: absolute;
          z-index: 1000;
          background: white;
          border: 1px solid #ccc;
          padding: 5px;
        }
        #context-menu button {
          background: none;
          border: none;
          padding: 5px;
          cursor: pointer;
          display: block;
          width: 100%;
          text-align: left;
        }
    </style>

    <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}" />

</head>
<body>
<h2>ëª¨ì„ ì±„íŒ…ë°©</h2>

<div>
    <label>groupId: <input type="text" id="groupId" /></label>
    <button onclick="connectWebSocket()">ì—°ê²°</button>
</div>

<div>
    <label>ë©”ì‹œì§€: <input type="text" id="message" /></label>
    <button onclick="sendMessage()">ë³´ë‚´ê¸°</button>
</div>

<div style="margin-top:10px;">
    <input type="text" id="searchKeyword" placeholder="ë©”ì‹œì§€ ê²€ìƒ‰" />
    <button onclick="searchMessages()">ê²€ìƒ‰</button>
</div>

<div id="chat-box" style="border:1px solid #ccc; margin-top:20px; padding:10px; height:300px; overflow-y:scroll;">
</div>

<div id="context-menu">
    <button id="context-edit" onclick="promptEdit()">âœ ë©”ì‹œì§€ ìˆ˜ì •</button>
    <button id="context-delete" onclick="promptDelete()">ğŸ—‘ ë©”ì‹œì§€ ì‚­ì œ</button>
    <button id="context-report" onclick="reportChat()">ğŸš¨ ë©”ì‹œì§€ ì‹ ê³ </button>
</div>


<script>
        let ws = null;
        let currentUserId = '';
        let currentUserIdx = '';  // ì¶”ê°€
        let editingMessageId = null;
        let editingUserId = null;


        function connectWebSocket() {
          const groupId = document.getElementById("groupId").value;

          if (!groupId) {
            alert("groupIdë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
          }

          if (ws && ws.readyState !== WebSocket.CLOSED) {
            ws.close();
          }

        const url = "ws://localhost:8080/ws/chat?groupId=" + encodeURIComponent(groupId);
          ws = new WebSocket(url);

          ws.onopen = () => console.log("âœ… ì—°ê²°ë¨");

          ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("ğŸ“¨ ë°›ì€ ë°ì´í„°:", data);

            const chatBox = document.getElementById("chat-box");

            if (data.type === "IDENTIFY" && data.userId) {
             currentUserId = data.userId;
             currentUserIdx = data.userIdx; // ì¶”ê°€!

             console.log("âœ… ë‚´ userId í™•ì •ë¨:", currentUserId);
             return;
            }

            if (data.type === "ERROR") {
              alert(`âš  ì˜¤ë¥˜: ${data.message}`);
              return;
            }

            if (data.type === "DELETE") {
              const target = [...chatBox.children].find(d => d.dataset.messageId === String(data.messageId));
              if (target) {
                target.innerHTML = `<i style="color:gray;">ì‚­ì œëœ ë©”ì‹œì§€ì…ë‹ˆë‹¤.</i>`;
              }
              return;
            }

            if (data.type === "EDIT") {
              const target = [...chatBox.children].find(d => d.dataset.messageId === String(data.messageId));
              if (target) {
                target.innerHTML = `<b>${data.from}:</b> ${data.newContent}`;
              }
              return;
            }

            const div = document.createElement("div");

            let timestamp = "";
            if (data.sentAt) {
              timestamp = `<span style="color:gray; font-size:0.8em;"> [${formatTime(data.sentAt)}]</span>`;
            }

            if (data.from && data.msg) {
              div.innerHTML = `<b>${data.from}:</b> ${data.msg} ${timestamp}`;
            } else if (data.system) {
              div.innerHTML = `<i>ì‹œìŠ¤í…œ: ${data.system}</i>`;
            } else {
              div.innerHTML = `<i style="color:red;">âš  ì²˜ë¦¬í•  ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€</i>`;
              console.warn("âš  ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ êµ¬ì¡°:", data);
            }

            if (data.userId) div.dataset.userId = data.userId;

            if (data.userIdx) div.dataset.userIdx = data.userIdx;

            if (data.messageId) div.dataset.messageId = data.messageId;

            div.addEventListener("contextmenu", (e) => {
  e.preventDefault();
  const messageId = div.dataset.messageId;
  const userIdx = div.dataset.userIdx;

  if (!messageId || !userIdx) return;

    editingMessageId = messageId;
    editingUserId = userIdx; // ìƒˆë¡œìš´ ë³€ìˆ˜ ë„ì…

    // ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ ì œì–´
    const isMyMessage = (Number(currentUserIdx) === Number(userIdx));

    document.querySelector('#context-edit').style.display = isMyMessage ? 'block' : 'none';
    document.querySelector('#context-delete').style.display = isMyMessage ? 'block' : 'none';
    document.querySelector('#context-report').style.display = 'block';

    showContextMenu(e.pageX, e.pageY);

});

            chatBox.appendChild(div);
          };

          ws.onclose = () => console.log("âŒ ì—°ê²° ì¢…ë£Œ");
        }

        function sendMessage() {
          const msg = document.getElementById("message").value;
          if (!msg || !ws || ws.readyState !== WebSocket.OPEN) {
            alert("WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          const json = { msg: msg };
          ws.send(JSON.stringify(json));
          document.getElementById("message").value = "";
        }

        function formatTime(isoTimeString) {
          const date = new Date(isoTimeString);
          const hours = date.getHours().toString().padStart(2, '0');
          const minutes = date.getMinutes().toString().padStart(2, '0');
          return `${hours}:${minutes}`;
        }

        function showContextMenu(x, y) {
          const menu = document.getElementById("context-menu");
          menu.style.left = x + "px";
          menu.style.top = y + "px";
          menu.style.display = "block";
        }

        function hideContextMenu() {
          document.getElementById("context-menu").style.display = "none";
        }

        function promptEdit() {
          const newContent = prompt("ìˆ˜ì •í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
          if (newContent && editingMessageId) {
            ws.send(JSON.stringify({
              type: "EDIT",
              messageId: editingMessageId,
              newContent: newContent,
              userId: currentUserId
            }));
          }
          hideContextMenu();
        }

        function promptDelete() {
          if (editingMessageId) {
            ws.send(JSON.stringify({
              type: "DELETE",
              messageId: editingMessageId,
              userId: currentUserId
            }));
          }
          hideContextMenu();
        }

        function searchMessages() {
          const keyword = document.getElementById("searchKeyword").value.trim();
          const groupId = document.getElementById("groupId").value;

          if (!groupId) {
            alert("groupIdë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
          }

          const url = keyword
            ? `/chat/search?groupId=${groupId}&keyword=${encodeURIComponent(keyword)}`
            : `/chat/history?groupId=${groupId}`;

          fetch(url)
            .then(response => response.json())
            .then(data => {
              const chatBox = document.getElementById("chat-box");
              chatBox.innerHTML = keyword
                ? "<b>ğŸ” ê²€ìƒ‰ ê²°ê³¼:</b><br>"
                : "<b>ğŸ’¬ ì „ì²´ ë©”ì‹œì§€ ëª©ë¡:</b><br>";

              if (data.length === 0) {
                chatBox.innerHTML += "<i>í‘œì‹œí•  ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</i>";
                return;
              }

              data.forEach(msg => {
                const time = msg.sentAt ? `[${formatTime(msg.sentAt)}]` : '';
                chatBox.innerHTML += `<div><b>${msg.nickname}:</b> ${msg.content} <span style="color:gray; font-size:0.8em;">${time}</span></div>`;
              });
            });
        }

        window.addEventListener("click", () => hideContextMenu());

        document.getElementById("message").addEventListener("keyup", function(event) {
          if (event.key === "Enter") sendMessage();
        });

    //ì‹ ê³ ì‹œì‘

    function reportChat() {
      if (!editingMessageId || !editingUserId) {
         alert("ì‹ ê³ í•  ë©”ì‹œì§€ë¥¼ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
         return;
      }


      // 4 = ì±„íŒ… ì‹ ê³  ì¹´í…Œê³ ë¦¬
      openReportModal('CHAT', editingMessageId, editingUserId, 3);
      hideContextMenu();
    }


        // âœ… ì‹ ê³  ëª¨ë‹¬ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
    let currentTargetType = null;
    let currentTargetId = null;
    let currentReportedUserId = null;
    let currentReportCategoryId = null;

    function openReportModal(type, id, userId, categoryId) {
      currentTargetType = type;
      currentTargetId = id;
      currentReportedUserId = userId;
      currentReportCategoryId = categoryId;
      document.getElementById('report-modal').style.display = 'block';

      //ë””ë²„ê¹…ìš©ì½”ë“œ
      console.log("ì‹ ê³  ëŒ€ìƒ userId í™•ì¸:", userId);

    }

    function closeReportModal() {
      document.getElementById('report-modal').style.display = 'none';
    }

    function submitReport() {
    const reasonId = document.getElementById('report-reason').value;
    const comment = document.getElementById('report-comment').value;

    if (!reasonId || !comment.trim()) {
      alert("ì‚¬ìœ ì™€ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    fetch("/api/reports", {
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
        [csrfHeader]: csrfToken
      },
      body: JSON.stringify({
        entityType: currentTargetType,
        entityId: Number(currentTargetId), // Numberë¡œ ë³€í™˜
        reportCategoryId: Number(currentReportCategoryId),
        reportReasonId: Number(reasonId),
        reportedUserId: Number(currentReportedUserId),
        reportComment: comment
      })
    })
    .then(async res => {
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.message || "ì‹ ê³  ì‹¤íŒ¨");
      }
      return res.json();
    })
    .then(() => {
      alert("ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
      closeReportModal();
    })
    .catch(err => alert("ì‹ ê³  ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message));
  }
</script>

<!-- âœ… ì‹ ê³  ëª¨ë‹¬ UI -->
<div id="report-modal" style="display:none; position:fixed; top:20%; left:40%; background:white; padding:20px; border:1px solid #ccc; z-index:9999;">
    <h3>ğŸš¨ ë©”ì‹œì§€ ì‹ ê³ </h3>
    <label>ì‹ ê³  ì‚¬ìœ 
        <select id="report-reason">
            <option value="1">ìš•ì„¤/ë¹„ë°©/í˜ì˜¤ í‘œí˜„</option>
            <option value="2">ìŒë€/ì„ ì •ì ì¸ ì½˜í…ì¸ </option>
            <option value="3">ë„ë°°/ìŠ¤íŒ¸/ê´‘ê³ </option>
            <option value="4">ê°œì¸ ì •ë³´ ë…¸ì¶œ</option>
            <option value="5">ì‚¬ì¹­/í—ˆìœ„ ì •ë³´</option>
            <option value="6">ë¶€ì ì ˆí•œ ë‚´ìš©</option>
            <option value="7">ëª¨ì„ ìš´ì˜ ë°©í•´</option>
            <option value="8">ê¸°íƒ€</option>
        </select>
    </label><br/><br/>
    <textarea id="report-comment" placeholder="ì‹ ê³  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" rows="4" cols="40"></textarea><br/><br/>
    <button onclick="submitReport()">ğŸš¨ ì‹ ê³  ì œì¶œ</button>
    <button onclick="closeReportModal()">âŒ ë‹«ê¸°</button>
</div>
</body>
</html>
