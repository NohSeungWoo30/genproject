<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>회원 정보</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { padding: 20px; }
    .info-section { margin-bottom: 40px; border: 1px solid #eee; padding: 20px; border-radius: 5px; background-color: #f9f9f9;}
    .info-section h3 { margin-bottom: 20px; color: #0056b3; }
    .info-item { margin-bottom: 15px; }
    .info-item label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
    .info-item p { margin: 0; padding: 8px 12px; background-color: #fff; border: 1px solid #ddd; border-radius: 4px; }
    .btn-edit { background-color: #28a745; color: white; }
    .btn-edit:hover { background-color: #218838; color: white; }
    .btn-delete { background-color: #dc3545; color: white; margin-top: 10px; } /* 회원 탈퇴 버튼 스타일 */
    .btn-delete:hover { background-color: #c82333; color: white; }
    .user-actions { margin-top: 40px; } /* 회원 탈퇴 섹션 상단 여백 */
  </style>
</head>
<body>
<div class="container">
  <h1 class="my-4">내 회원 정보</h1>

  <div class="info-section">
    <h3>회원 상세 정보</h3>
    <div class="info-item">
      <label>아이디</label>
      <p th:text="${user.userId}">user123</p>
    </div>
    <div class="info-item">
      <label>이름</label>
      <p th:text="${user.userName}">홍길동</p>
    </div>
    <div class="info-item">
      <label>닉네임</label>
      <p th:text="${user.nickname}">홍길동</p>
    </div>
    <div class="info-item">
      <label>생년월일</label>
      <p th:text="${user.birthDate} ? ${#temporals.format(user.birthDate, 'yyyy-MM-dd')} : '미입력'">1990-01-01</p>
    </div>
    <div class="info-item">
      <label>성별</label>
      <p>
        <span th:if="${user.gender != null and user.gender.toString().equals('M')}">남성</span>
        <span th:if="${user.gender != null and user.gender.toString().equals('F')}">여성</span>
        <span th:if="${user.gender != null and user.gender.toString().equals('O')}">기타</span>
        <span th:if="${user.gender == null or (user.gender != null and !(user.gender.toString().equals('M') or user.gender.toString().equals('F') or user.gender.toString().equals('O')))}">미입력</span>
      </p>
    </div>
    <div class="info-item">
      <label>이메일</label>
      <p th:text="${user.email}">user@example.com</p>
    </div>
    <div class="info-item">
      <label>전화번호</label>
      <p th:text="${user.phone} ? ${user.phone} : '미입력'">010-1234-5678</p>
    </div>
    <div class="info-item">
      <label>프로필 사진 이름</label>
      <p th:text="${user.profileName} ? ${user.profileName} : '없음'">profile.jpg</p>
    </div>
    <div class="info-item">
      <label>소개</label>
      <p th:text="${user.introduction} ? ${user.introduction} : '자기소개가 없습니다.'">안녕하세요!</p>
    </div>

    <a th:href="@{/user/profile-edit}" class="btn btn-edit mt-3">정보 수정</a>
  </div>

  <div class="user-actions">
    <hr>
    <h3>계정 삭제</h3>
    <p>계정을 삭제하면 모든 정보가 삭제되며, 계정은 복구할 수 없습니다.</p>
    <button type="button" id="openDeleteModalBtn" class="btn btn-delete">계정 삭제</button>
  </div>

  <a th:href="@{/main}" class="btn btn-secondary mt-3">메인으로 돌아가기</a>
</div>

<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteAccountModalLabel">계정 삭제 확인</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>계정을 삭제하시려면 현재 비밀번호를 입력해 주세요. 계정 삭제 후에는 복구할 수 없습니다.</p>
        <div class="mb-3">
          <label for="currentPasswordConfirm" class="form-label">현재 비밀번호</label>
          <input type="password" class="form-control" id="currentPasswordConfirm">
        </div>
        <div id="deleteErrorMsg" class="text-danger mt-2" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger">삭제</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RVR" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSd4U8A6fL5o1p0L501qA1sK+yEaE8t7QeIeE" crossorigin="anonymous"></script>

<script th:inline="javascript">
  /*<![CDATA[*/
  // CSRF 토큰 값을 Thymeleaf에서 JavaScript 변수로 가져옵니다.
  // _csrf 객체가 null일 수 있으므로 null 체크를 추가합니다.
  const csrfParameterName = /*[[${_csrf != null ? _csrf.parameterName : ''}]]*/ '';
  const csrfToken = /*[[${_csrf != null ? _csrf.token : ''}]]*/ '';
  /*]]>*/

  // '계정 삭제' 버튼 클릭 시 모달 열기
  document.getElementById('openDeleteModalBtn').addEventListener('click', function() {
      // Bootstrap 4에서는 jQuery를 사용하여 모달을 엽니다.
      // jQuery가 제대로 로드되었다면 이 코드가 동작해야 합니다.
      $('#deleteAccountModal').modal('show');
      document.getElementById('deleteErrorMsg').style.display = 'none';
      document.getElementById('currentPasswordConfirm').value = '';
  });

  // 모달 내 '삭제' 버튼 클릭 시
  document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
      const passwordConfirm = document.getElementById('currentPasswordConfirm').value;
      const deleteErrorMsg = document.getElementById('deleteErrorMsg');
      deleteErrorMsg.style.display = 'none';

      if (!passwordConfirm) {
          deleteErrorMsg.textContent = '비밀번호를 입력해주세요.';
          deleteErrorMsg.style.display = 'block';
          return;
      }

      const formData = new URLSearchParams();
      formData.append('passwordConfirm', passwordConfirm);

      if (csrfParameterName && csrfToken) {
          formData.append(csrfParameterName, csrfToken);
      }

      fetch('/user/delete', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: formData.toString(),
          credentials: 'include'
      })
      .then(response => {
          if (response.redirected) {
              // 서버에서 리다이렉트 응답을 보냈을 때 (예: 302 Found)
              // 이곳으로 들어옵니다. Spring Security의 로그인 페이지 리다이렉트가 이 경우입니다.
              console.warn('Redirect detected. Navigating to:', response.url); // 추가
              window.location.href = response.url;
              return null; // 이후 .then 체인을 중단
          }
          if (response.ok) {
              // 200 OK 응답일 때
              return response.json();
          } else {
              // 4xx, 5xx 오류 응답일 때 (그러나 JSON 응답인 경우)
              return response.json().then(errorData => {
                  throw new Error(errorData.message || '계정 삭제 실패');
              });
          }
      })
      .then(data => {
          if (data === null) return; // 리다이렉트된 경우 data가 null이므로 처리 중단

          if (data.success) {
              alert(data.message || '계정이 성공적으로 삭제되었습니다.');
              window.location.href = '/user/login?logout';
          } else {
              deleteErrorMsg.textContent = data.message || '계정 삭제에 실패했습니다.';
              deleteErrorMsg.style.display = 'block';
          }
      })
      .catch(error => {
          console.error('Error during fetch:', error);
          deleteErrorMsg.textContent = error.message || '알 수 없는 오류가 발생했습니다.';
          deleteErrorMsg.style.display = 'block';
      });
  });
</script>

</body>
</html>