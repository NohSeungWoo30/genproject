<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
        /* 메시지 스타일 */
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .success-message {
            color: green;
            font-size: 0.9em;
            margin-top: 5px;
        }
        /* 입력 필드와 메시지 간격 조정 */
        div {
            margin-bottom: 10px;
        }
        input {
            margin-right: 5px;
        }
        /* ⭐ 추가: 프로필 이미지 미리보기 스타일 ⭐ */
        #profileImagePreview {
            width: 100px; /* 적절한 크기로 조정 */
            height: 100px; /* 적절한 크기로 조정 */
            border-radius: 50%; /* 원형 이미지 */
            object-fit: cover; /* 이미지가 잘리지 않고 채워지도록 */
            border: 1px solid #ddd;
            margin-top: 10px;
            display: block; /* 블록 요소로 표시 */
        }
    </style>
</head>
<body>
<h2>회원가입 🙌</h2>
<form th:action="@{/user/signup}" method="post" th:object="${user}" enctype="multipart/form-data">
    <div>
        <label for="userId">아이디:</label>
        <input type="text" id="userId" th:field="*{userId}" required />
        <p id="userIdMessage" class="validation-message"></p>
    </div>
    <div>
        <label for="userName">이름:</label>
        <input type="text" id="userName" th:field="*{userName}" />
    </div>
    <div>
        <label for="nickname">닉네임:</label>
        <input type="text" id="nickname" th:field="*{nickname}" required />
        <p id="nicknameMessage" class="validation-message"></p>
    </div>
    <div>
        <label for="birthDate">생년월일:</label>
        <input type="date" id="birthDate" th:field="*{birthDate}" />
    </div>
    <div>
        <label for="gender">성별:</label>
        <select id="gender" th:field="*{gender}">
            <option value="M">남자</option>
            <option value="F">여자</option>
        </select>
    </div>
    <div>
        <label for="email">이메일:</label>
        <input type="email" id="email" th:field="*{email}" required />
        <p id="emailMessage" class="validation-message"></p>
    </div>
    <div>
        <label for="phone">전화번호:</label>
        <input type="text" id="phone" th:field="*{phone}" required placeholder="예: 01012345678" />
        <p id="phoneMessage" class="validation-message"></p>
    </div>
    <div>
        <label for="password">비밀번호:</label>
        <input type="password" id="password" th:field="*{password}" required />
    </div>
    <div>
        <label for="profileImageFile">프로필 사진:</label>
        <input type="file" id="profileImageFile" name="profileImageFile" accept="image/*">
        <img id="profileImagePreview" src="/images/profile_upload/default_profile.jpg" alt="프로필 이미지 미리보기">
        <p>선택하지 않으면 기본 이미지가 적용됩니다. (최대 10MB)</p>
    </div>
    <div>
        <label for="introduction">자기소개:</label>
        <input type="text" id="introduction" th:field="*{introduction}" />
    </div>
    <button type="submit" id="submitButton">가입하기</button>
</form>

<script th:inline="javascript">
    /*<![CDATA[*/
    // CSRF 토큰을 Thymeleaf를 통해 서버에서 주입받습니다.
    const csrfParameterName = /*[[${_csrf != null ? _csrf.parameterName : ''}]]*/ '';
    const csrfToken = /*[[${_csrf != null ? _csrf.token : ''}]]*/ '';
    /*]]>*/

    $(document).ready(function() {
        // 모든 유효성 검사 통과 여부를 추적하는 객체
        const validationStatus = {
            userId: false,
            nickname: false,
            email: false,
            phone: false,
             // CI는 필수가 아니거나, 중복 확인을 나중에 추가할 경우 기본 true로 설정하는 것이 합리적입니다.
                        // 만약 CI도 필수 중복 확인이 필요하다면 `false`로 변경 후 checkDuplication 호출
        };

        // 회원가입 버튼 상태 업데이트 함수
        function updateSubmitButtonStatus() {
            // 모든 중복확인 필드가 유효하고, 비밀번호가 입력되어 있어야 버튼 활성화
            const allValid = Object.values(validationStatus).every(status => status === true);
            const passwordEntered = $('#password').val().trim() !== '';

            $('#submitButton').prop('disabled', !(allValid && passwordEntered));
        }

        // 초기 버튼 상태 설정 (처음에는 비활성화)
        updateSubmitButtonStatus();

        // 공통 중복 확인 함수
        function checkDuplication(inputId, messageId, apiEndpoint, paramName, validationKey) {
            const $input = $('#' + inputId);
            const $message = $('#' + messageId);

            $input.on('blur', function() {
                const value = $input.val().trim();
                if (value === '') {
                    $message.text('필수 항목입니다.').removeClass('success-message').addClass('error-message'); // 빈 값일 경우 오류 메시지
                    validationStatus[validationKey] = false;
                    updateSubmitButtonStatus();
                    return;
                }

                $.ajax({
                    url: '/user/' + apiEndpoint, // UserController의 @RequestMapping("/user")와 결합
                    type: 'GET',
                    data: { [paramName]: value },
                    success: function(response) {
                        if (response.duplicated) {
                            $message.text('이미 사용 중입니다.').removeClass('success-message').addClass('error-message');
                            validationStatus[validationKey] = false;
                        } else {
                            $message.text('사용 가능합니다.').removeClass('error-message').addClass('success-message');
                            validationStatus[validationKey] = true;
                        }
                        updateSubmitButtonStatus();
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX Error: ", status, error);
                        $message.text('중복 확인 중 오류가 발생했습니다.').addClass('error-message');
                        validationStatus[validationKey] = false;
                        updateSubmitButtonStatus();
                    }
                });
            });

            // (선택 사항) 입력 중에도 실시간으로 체크하려면 'keyup' 이벤트 추가
            $input.on('keyup', function() {
                 // 비밀번호 입력 시에도 버튼 상태 업데이트 (공백이 아닌지 확인)
                updateSubmitButtonStatus();
            });
        }

        // 각 필드에 대한 중복 확인 설정
        checkDuplication('userId', 'userIdMessage', 'check/userId', 'userId', 'userId');
        checkDuplication('nickname', 'nicknameMessage', 'check/nickname', 'nickname', 'nickname');
        checkDuplication('email', 'emailMessage', 'check/email', 'email', 'email');
        checkDuplication('phone', 'phoneMessage', 'check/phone', 'phone', 'phone');
        // userCi도 UNIQUE 제약 조건이 있다면 아래 주석 해제하여 사용
        // checkDuplication('userCi', 'userCiMessage', 'check/userCi', 'userCi', 'userCi');

        // 비밀번호 입력 시 버튼 상태 업데이트
        $('#password').on('keyup', updateSubmitButtonStatus);


        // ⭐ 프로필 이미지 미리보기 기능 ⭐
        const $profileImageInput = $('#profileImageFile');
        const $profileImagePreview = $('#profileImagePreview');

        $profileImageInput.on('change', function(event) {
            const file = event.target.files[0]; // 선택된 파일 가져오기
            if (file) {
                const reader = new FileReader(); // FileReader 객체 생성
                reader.onload = function(e) {
                    $profileImagePreview.attr('src', e.target.result); // 미리보기 이미지의 src를 선택된 파일의 데이터 URL로 설정
                    $profileImagePreview.show(); // 이미지를 보이게 함
                };
                reader.readAsDataURL(file); // 파일을 Data URL로 읽어들임
            } else {
                $profileImagePreview.attr('src', '/images/profile_upload/default_profile.jpg'); // 파일 선택 취소 시 기본 이미지로 되돌리기
            }
        });

        // 폼 제출 이벤트 가로채기 (선택 사항: jQuery serialize() 대신 FormData 사용)
        $('form').on('submit', function(event) {
            // 필수 필드가 비어있거나, 유효성 검사를 통과하지 못하면 제출 방지
            const allFieldsValid = Object.values(validationStatus).every(status => status === true);
            const passwordEntered = $('#password').val().trim() !== '';

            if (!allFieldsValid || !passwordEntered) {
                alert("모든 필수 입력 필드를 올바르게 작성해야 합니다.");
                event.preventDefault(); // 폼 제출 중단
                return;
            }

            // AJAX로 폼 데이터 전송
            event.preventDefault(); // 기본 폼 제출 동작 방지

            const $form = $(this);
            const formData = new FormData($form[0]); // jQuery 객체에서 DOM 요소 추출 후 FormData 생성

            // CSRF 토큰을 FormData에 추가
            if (csrfParameterName && csrfToken) {
                formData.append(csrfParameterName, csrfToken);
            }

            $.ajax({
                url: $form.attr('action'), // 폼의 action 속성 사용
                type: $form.attr('method'), // 폼의 method 속성 사용
                data: formData,
                processData: false, // FormData를 사용할 때는 false
                contentType: false, // FormData를 사용할 때는 false
                success: function(response) {
                    // 서버 응답이 JSON 형식이라고 가정
                    if (response.success) {
                        alert(response.message || '회원가입이 완료되었습니다. 로그인 페이지로 이동합니다.');
                        window.location.href = '/user/login'; // Spring Security 로그인 페이지로 이동
                    } else {
                        alert('회원가입 실패: ' + (response.message || '알 수 없는 오류가 발생했습니다.'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX Submission Error: ", status, error, xhr.responseText);
                    const errorMessage = xhr.responseJSON ? xhr.responseJSON.message : '서버 요청 중 오류가 발생했습니다.';
                    alert('회원가입 중 오류가 발생했습니다: ' + errorMessage);
                }
            });
        });
    });
</script>
</body>
</html>