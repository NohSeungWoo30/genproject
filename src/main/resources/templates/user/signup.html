<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>íšŒì›ê°€ì…</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            background: #f5f5f5;
            font-family: "Pretendard-Regular", sans-serif;
            color: #333;
            line-height: 1.4;
        }

        /* ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .container {
            max-width: 400px;
            margin: 60px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 20px 24px 32px;
        }

        /* ì œëª© ìŠ¤íƒ€ì¼ */
        h2 {
            text-align: center;
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 24px;
        }

        /* ê° í¼ ê·¸ë£¹ (div) ìŠ¤íƒ€ì¼ */
        form > div { /* form ë°”ë¡œ í•˜ìœ„ì˜ divì— ì ìš© */
            margin-bottom: 16px;
        }

        /* ë¼ë²¨ ìŠ¤íƒ€ì¼ */
        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
        }

        /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ (input, select, textarea í¬í•¨) */
        input[type="text"],
        input[type="password"],
        input[type="email"],
        input[type="tel"],
        input[type="date"], /* date inputì€ ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ëŒ€ì²´ë˜ì—ˆì§€ë§Œ í˜¹ì‹œ ëª°ë¼ ìœ ì§€ */
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fafafa;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #6a5acd;
            background: #fff;
        }

        /* íŒŒì¼ ì…ë ¥ í•„ë“œ íŠ¹ì • ìŠ¤íƒ€ì¼ */
        input[type="file"] {
            padding: 8px 12px;
            background: #fff;
        }

        /* ì‘ì€ í…ìŠ¤íŠ¸ (ì„¤ëª…, ë©”ì‹œì§€) ìŠ¤íƒ€ì¼ */
        p.validation-message, /* ìœ íš¨ì„± ë©”ì‹œì§€ */
        form > div > p { /* í”„ë¡œí•„ ì‚¬ì§„ ì„¤ëª… ë“± */
            display: block;
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .success-message {
            color: green;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* í”„ë¡œí•„ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ */
        #profileImagePreview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #ddd;
            margin: 10px auto 0;
            display: block;
        }

        /* ìƒë…„ì›”ì¼ ë“œë¡­ë‹¤ìš´ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
        .birthdate-select-group {
            display: flex;
            gap: 8px;
        }
        .birthdate-select-group select {
            width: auto;
            flex-grow: 1;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-submit {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: 500;
            background: #6a5acd;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
        }
        .btn-submit:hover {
            background: #5548b6;
        }
        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* í•˜ë‹¨ ë§í¬ ìŠ¤íƒ€ì¼ */
        .text-center {
            text-align: center;
            margin-top: 12px;
            font-size: 13px;
        }
        .text-center a {
            color: #6a5acd;
            text-decoration: none;
        }
        .text-center a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>íšŒì›ê°€ì… ğŸ™Œ</h2>
    <form th:action="@{/user/signup}" method="post" th:object="${user}" enctype="multipart/form-data">
        <div>
            <label for="userId">ì•„ì´ë””</label>
            <input type="text" id="userId" th:field="*{userId}" required />
            <p id="userIdMessage" class="validation-message"></p>
        </div>
        <div>
            <label for="userName">ì´ë¦„</label>
            <input type="text" id="userName" th:field="*{userName}" />
        </div>
        <div>
            <label for="nickname">ë‹‰ë„¤ì„</label>
            <input type="text" id="nickname" th:field="*{nickname}" required />
            <p id="nicknameMessage" class="validation-message"></p>
        </div>
        <div>
            <label>ìƒë…„ì›”ì¼</label>
            <div class="birthdate-select-group">
                <select id="birthYear" required></select>
                <select id="birthMonth" required></select>
                <select id="birthDay" required></select>
            </div>
        </div>
        <div>
            <label for="gender">ì„±ë³„</label>
            <select id="gender" th:field="*{gender}">
                <option value="M">ë‚¨ì„±</option>
                <option value="F">ì—¬ì„±</option>
            </select>
        </div>
        <div>
            <label for="email">ì´ë©”ì¼</label>
            <input type="email" id="email" th:field="*{email}" required />
            <p id="emailMessage" class="validation-message"></p>
        </div>
        <div>
            <label for="phone">ì „í™”ë²ˆí˜¸</label>
            <input type="text" id="phone" th:field="*{phone}" required placeholder="ì˜ˆ: 01012345678" />
            <p id="phoneMessage" class="validation-message"></p>
        </div>
        <div>
            <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="password" th:field="*{password}" required />
        </div>
        <div>
            <label for="profileImageFile">í”„ë¡œí•„ ì´ë¯¸ì§€</label>
            <input type="file" id="profileImageFile" name="profileImageFile" accept="image/*">
            <img id="profileImagePreview" src="/images/profile_upload/default_profile.jpg" alt="í”„ë¡œí•„ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
            <p>ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€ê°€ ì ìš©ë©ë‹ˆë‹¤. (ìµœëŒ€ 10MB)</p>
        </div>
        <div>
            <label for="introduction">ìê¸°ì†Œê°œ</label>
            <textarea id="introduction" th:field="*{introduction}" rows="4" placeholder="ìì‹ ì„ ì†Œê°œí•˜ëŠ” ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
        </div>
        <button type="submit" id="submitButton" class="btn-submit">ê°€ì…í•˜ê¸°</button>
    </form>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // CSRF í† í°ì€ Thymeleaf í¼ ì œì¶œ ë°©ì‹ì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë˜ì§€ë§Œ, AJAX ì¤‘ë³µ í™•ì¸ì„ ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.
    const csrfParameterName = /*[[${_csrf != null ? _csrf.parameterName : ''}]]*/ '';
    const csrfToken = /*[[${_csrf != null ? _csrf.token : ''}]]*/ '';
    /*]]>*/

    $(document).ready(function() {
        // ëª¨ë“  ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼ ì—¬ë¶€ë¥¼ ì¶”ì í•˜ëŠ” ê°ì²´
        const validationStatus = {
            userId: false,
            nickname: false,
            email: false,
            phone: false,
            birthDate: false
        };

        // íšŒì›ê°€ì… ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateSubmitButtonStatus() {
            // ëª¨ë“  ì¤‘ë³µí™•ì¸ í•„ë“œê°€ ìœ íš¨í•˜ê³ , ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì–´ ìˆì–´ì•¼ ë²„íŠ¼ í™œì„±í™”
            const allValid = Object.values(validationStatus).every(status => status === true);
            const passwordEntered = $('#password').val().trim() !== '';

            $('#submitButton').prop('disabled', !(allValid && passwordEntered));
        }

        // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì • (ì²˜ìŒì—ëŠ” ë¹„í™œì„±í™”)
        updateSubmitButtonStatus();

        // â­ ìƒë…„ì›”ì¼ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™” ë° ìœ íš¨ì„± ê²€ì‚¬ â­
        const $birthYear = $('#birthYear');
        const $birthMonth = $('#birthMonth');
        const $birthDay = $('#birthDay');

        function populateYears() {
            const currentYear = new Date().getFullYear();
            $birthYear.append('<option value="">ì—°ë„</option>');
            for (let i = currentYear; i >= currentYear - 100; i--) { // ê³¼ê±° 100ë…„ê¹Œì§€
                $birthYear.append('<option value="' + i + '">' + i + '</option>');
            }
        }

        function populateMonths() {
            $birthMonth.append('<option value="">ì›”</option>');
            for (let i = 1; i <= 12; i++) {
                $birthMonth.append('<option value="' + String(i).padStart(2, '0') + '">' + i + '</option>');
            }
        }

        function populateDays() {
            const year = parseInt($birthYear.val());
            const month = parseInt($birthMonth.val());
            const $birthDay = $('#birthDay');
            $birthDay.empty().append('<option value="">ì¼</option>'); // ê¸°ì¡´ ì˜µì…˜ ë¹„ìš°ê³  "ì¼" ì¶”ê°€

            if (year && month) {
                const daysInMonth = new Date(year, month, 0).getDate(); // í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ 
                for (let i = 1; i <= daysInMonth; i++) {
                    $birthDay.append('<option value="' + String(i).padStart(2, '0') + '">' + i + '</option>');
                }
            }
            validateBirthDate(); // ë‚ ì§œê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ìœ íš¨ì„± ê²€ì‚¬
        }

        function validateBirthDate() {
            const year = $birthYear.val();
            const month = $birthMonth.val();
            const day = $birthDay.val();

            // ëª¨ë“  ë“œë¡­ë‹¤ìš´ì´ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (year && month && day) {
                const selectedDate = new Date(year, parseInt(month) - 1, day);
                // ì„ íƒëœ ë‚ ì§œê°€ ìœ íš¨í•œ ë‚ ì§œì¸ì§€ ì¶”ê°€ ê²€ì‚¬ (ì˜ˆ: 2ì›” 30ì¼ê³¼ ê°™ì€ ê²½ìš°)
                if (selectedDate.getFullYear() == year &&
                    selectedDate.getMonth() == parseInt(month) - 1 &&
                    selectedDate.getDate() == day) {
                    validationStatus.birthDate = true;
                } else {
                    validationStatus.birthDate = false;
                }
            } else {
                validationStatus.birthDate = false;
            }
            updateSubmitButtonStatus();
        }

        populateYears();
        populateMonths();

        $birthYear.on('change', function() {
            populateDays();
            validateBirthDate();
        });
        $birthMonth.on('change', function() {
            populateDays();
            validateBirthDate();
        });
        $birthDay.on('change', validateBirthDate); // ì¼ ì„ íƒ ì‹œ ë°”ë¡œ ìœ íš¨ì„± ê²€ì‚¬

        // ê³µí†µ ì¤‘ë³µ í™•ì¸ í•¨ìˆ˜
        function checkDuplication(inputId, messageId, apiEndpoint, paramName, validationKey) {
            const $input = $('#' + inputId);
            const $message = $('#' + messageId);

            $input.on('blur', function() {
                const value = $input.val().trim();
                if (value === '') {
                    $message.text('í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.').removeClass('success-message').addClass('error-message');
                    // ì§ì ‘ ìŠ¤íƒ€ì¼ ì„¤ì •
                    $message.css('color', 'red'); // ë¹¨ê°„ìƒ‰
                    $message.css('font-weight', 'bold'); // êµµê²Œ
                    validationStatus[validationKey] = false;
                    updateSubmitButtonStatus();
                    return;
                }

                $.ajax({
                    url: '/user/' + apiEndpoint, // UserControllerì˜ @RequestMapping("/user")ì™€ ê²°í•©
                    type: 'GET',
                    data: { [paramName]: value },
                    success: function(response) {
                        if (response.duplicated) {
                            $message.text('ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.').removeClass('success-message').addClass('error-message');
                            // ì§ì ‘ ìŠ¤íƒ€ì¼ ì„¤ì •
                            $message.css('color', 'red');
                            $message.css('font-weight', 'bold');
                            validationStatus[validationKey] = false;
                        } else {
                            $message.text('ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.').removeClass('error-message').addClass('success-message');
                            // ì§ì ‘ ìŠ¤íƒ€ì¼ ì„¤ì •
                            $message.css('color', 'green'); // ì´ˆë¡ìƒ‰
                            $message.css('font-weight', 'bold');
                            validationStatus[validationKey] = true;
                        }
                        updateSubmitButtonStatus();
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX Error: ", status, error);
                        $message.text('ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.').addClass('error-message');
                        // ì§ì ‘ ìŠ¤íƒ€ì¼ ì„¤ì •
                        $message.css('color', 'red');
                        $message.css('font-weight', 'bold');
                        validationStatus[validationKey] = false;
                        updateSubmitButtonStatus();
                    }
                });
            });

            // (ì„ íƒ ì‚¬í•­) ì…ë ¥ ì¤‘ì—ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì²´í¬í•˜ë ¤ë©´ 'keyup' ì´ë²¤íŠ¸ ì¶”ê°€
            $input.on('keyup', function() {
                 updateSubmitButtonStatus();
            });
        }

        // ê° í•„ë“œì— ëŒ€í•œ ì¤‘ë³µ í™•ì¸ ì„¤ì •
        checkDuplication('userId', 'userIdMessage', 'check/userId', 'userId', 'userId');
        checkDuplication('nickname', 'nicknameMessage', 'check/nickname', 'nickname', 'nickname');
        checkDuplication('email', 'emailMessage', 'check/email', 'email', 'email');
        checkDuplication('phone', 'phoneMessage', 'check/phone', 'phone', 'phone');

        // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        $('#password').on('keyup', updateSubmitButtonStatus);

        // í”„ë¡œí•„ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥
        const $profileImageInput = $('#profileImageFile');
        const $profileImagePreview = $('#profileImagePreview');

        $profileImageInput.on('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $profileImagePreview.attr('src', e.target.result);
                    $profileImagePreview.show();
                };
                reader.readAsDataURL(file);
            } else {
                $profileImagePreview.attr('src', '/images/profile_upload/default_profile.jpg');
            }
        });

        // â­ í¼ ì œì¶œ ì´ë²¤íŠ¸ ê°€ë¡œì±„ê¸° (AJAX ì œì¶œ ëŒ€ì‹  ì¼ë°˜ í¼ ì œì¶œë¡œ ë³€ê²½) â­
        $('form').on('submit', function(event) {
            const allFieldsValid = Object.values(validationStatus).every(status => status === true);
            const passwordEntered = $('#password').val().trim() !== '';

            if (!allFieldsValid || !passwordEntered) {
                alert("ëª¨ë“  í•„ìˆ˜ ì…ë ¥ í•„ë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.");
                event.preventDefault(); // í¼ ì œì¶œ ì¤‘ë‹¨
                return;
            }

            // â­ ìƒë…„ì›”ì¼ ê°’ì„ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì¡°í•©í•˜ì—¬ hidden inputì— ì„¤ì • â­
            // Thymeleafì˜ th:object="${user}"ì™€ ì—°ë™ë˜ë„ë¡ name ì†ì„±ì„ user.birthDateë¡œ ì„¤ì •
            const year = $birthYear.val();
            const month = $birthMonth.val();
            const day = $birthDay.val();

            if (year && month && day) {
                const birthDateValue = `${year}-${month}-${day}`;
                // ê¸°ì¡´ formì— hidden inputì„ ì¶”ê°€í•˜ê±°ë‚˜, ì´ë¯¸ ìˆë‹¤ë©´ ê°’ì„ ì—…ë°ì´íŠ¸
                let $birthDateHiddenInput = $('input[name="birthDate"]');
                if ($birthDateHiddenInput.length === 0) {
                    $birthDateHiddenInput = $('<input>').attr({
                        type: 'hidden',
                        name: 'birthDate', // UserDTOì˜ í•„ë“œ ì´ë¦„ê³¼ ì¼ì¹˜
                        id: 'hiddenBirthDate' // í•„ìš” ì‹œ ID ì¶”ê°€
                    }).appendTo(this); // í˜„ì¬ í¼ì— ì¶”ê°€
                }
                $birthDateHiddenInput.val(birthDateValue);
            } else {
                alert("ìƒë…„ì›”ì¼ì„ ì˜¬ë°”ë¥´ê²Œ ì„ íƒí•´ì£¼ì„¸ìš”.");
                event.preventDefault(); // í¼ ì œì¶œ ì¤‘ë‹¨
                return;
            }

            // CSRF í† í°ì€ Thymeleaf í¼ì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ ìˆ˜ë™ ì¶”ê°€ í•„ìš” ì—†ìŒ.
            // ë‹¤ë§Œ, AJAX ì¤‘ë³µ í™•ì¸ ì‹œì—ëŠ” í•„ìš”í•˜ë¯€ë¡œ ìœ„ìª½ ë³€ìˆ˜ëŠ” ìœ ì§€.

            // ì—¬ê¸°ê¹Œì§€ ì˜¤ë©´ í¼ì´ ì •ìƒì ìœ¼ë¡œ ì„œë²„ë¡œ ì œì¶œë©ë‹ˆë‹¤ (AJAX ì•„ë‹˜).
            // ì„œë²„ëŠ” ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‘ë‹µì„ ë³´ë‚´ê³  ë¸Œë¼ìš°ì €ê°€ ì´ë¥¼ ë”°ë¼ê°ˆ ê²ƒì…ë‹ˆë‹¤.
        });
    });
</script>
</body>
</html>