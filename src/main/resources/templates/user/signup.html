<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>íšŒì›ê°€ì…</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .success-message {
            color: green;
            font-size: 0.9em;
            margin-top: 5px;
        }
        /* ì…ë ¥ í•„ë“œì™€ ë©”ì‹œì§€ ê°„ê²© ì¡°ì • */
        div {
            margin-bottom: 10px;
        }
        input {
            margin-right: 5px;
        }
        /* â­ ì¶”ê°€: í”„ë¡œí•„ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ â­ */
        #profileImagePreview {
            width: 100px; /* ì ì ˆí•œ í¬ê¸°ë¡œ ì¡°ì • */
            height: 100px; /* ì ì ˆí•œ í¬ê¸°ë¡œ ì¡°ì • */
            border-radius: 50%; /* ì›í˜• ì´ë¯¸ì§€ */
            object-fit: cover; /* ì´ë¯¸ì§€ê°€ ì˜ë¦¬ì§€ ì•Šê³  ì±„ì›Œì§€ë„ë¡ */
            border: 1px solid #ddd;
            margin-top: 10px;
            display: block; /* ë¸”ë¡ ìš”ì†Œë¡œ í‘œì‹œ */
        }
    </style>
</head>
<body>
<h2>íšŒì›ê°€ì… ğŸ™Œ</h2>
<form th:action="@{/user/signup}" method="post" th:object="${user}" enctype="multipart/form-data">
    <div>
        <label for="userId">ì•„ì´ë””:</label>
        <input type="text" id="userId" th:field="*{userId}" required />
        <p id="userIdMessage" class="validation-message"></p>
    </div>
    <div>
        <label for="userName">ì´ë¦„:</label>
        <input type="text" id="userName" th:field="*{userName}" />
    </div>
    <div>
        <label for="nickname">ë‹‰ë„¤ì„:</label>
        <input type="text" id="nickname" th:field="*{nickname}" required />
        <p id="nicknameMessage" class="validation-message"></p>
    </div>
    <div>
        <label for="birthDate">ìƒë…„ì›”ì¼:</label>
        <input type="date" id="birthDate" th:field="*{birthDate}" />
    </div>
    <div>
        <label for="gender">ì„±ë³„:</label>
        <select id="gender" th:field="*{gender}">
            <option value="M">ë‚¨ì</option>
            <option value="F">ì—¬ì</option>
        </select>
    </div>
    <div>
        <label for="email">ì´ë©”ì¼:</label>
        <input type="email" id="email" th:field="*{email}" required />
        <p id="emailMessage" class="validation-message"></p>
    </div>
    <div>
        <label for="phone">ì „í™”ë²ˆí˜¸:</label>
        <input type="text" id="phone" th:field="*{phone}" required placeholder="ì˜ˆ: 01012345678" />
        <p id="phoneMessage" class="validation-message"></p>
    </div>
    <div>
        <label for="password">ë¹„ë°€ë²ˆí˜¸:</label>
        <input type="password" id="password" th:field="*{password}" required />
    </div>
    <div>
        <label for="profileImageFile">í”„ë¡œí•„ ì‚¬ì§„:</label>
        <input type="file" id="profileImageFile" name="profileImageFile" accept="image/*">
        <img id="profileImagePreview" src="/images/profile_upload/default_profile.jpg" alt="í”„ë¡œí•„ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
        <p>ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€ê°€ ì ìš©ë©ë‹ˆë‹¤. (ìµœëŒ€ 10MB)</p>
    </div>
    <div>
        <label for="introduction">ìê¸°ì†Œê°œ:</label>
        <input type="text" id="introduction" th:field="*{introduction}" />
    </div>
    <button type="submit" id="submitButton">ê°€ì…í•˜ê¸°</button>
</form>

<script th:inline="javascript">
    /*<![CDATA[*/
    // CSRF í† í°ì„ Thymeleafë¥¼ í†µí•´ ì„œë²„ì—ì„œ ì£¼ì…ë°›ìŠµë‹ˆë‹¤.
    const csrfParameterName = /*[[${_csrf != null ? _csrf.parameterName : ''}]]*/ '';
    const csrfToken = /*[[${_csrf != null ? _csrf.token : ''}]]*/ '';
    /*]]>*/

    $(document).ready(function() {
        // ëª¨ë“  ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼ ì—¬ë¶€ë¥¼ ì¶”ì í•˜ëŠ” ê°ì²´
        const validationStatus = {
            userId: false,
            nickname: false,
            email: false,
            phone: false,
             // CIëŠ” í•„ìˆ˜ê°€ ì•„ë‹ˆê±°ë‚˜, ì¤‘ë³µ í™•ì¸ì„ ë‚˜ì¤‘ì— ì¶”ê°€í•  ê²½ìš° ê¸°ë³¸ trueë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì´ í•©ë¦¬ì ì…ë‹ˆë‹¤.
                        // ë§Œì•½ CIë„ í•„ìˆ˜ ì¤‘ë³µ í™•ì¸ì´ í•„ìš”í•˜ë‹¤ë©´ `false`ë¡œ ë³€ê²½ í›„ checkDuplication í˜¸ì¶œ
        };

        // íšŒì›ê°€ì… ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateSubmitButtonStatus() {
            // ëª¨ë“  ì¤‘ë³µí™•ì¸ í•„ë“œê°€ ìœ íš¨í•˜ê³ , ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì–´ ìˆì–´ì•¼ ë²„íŠ¼ í™œì„±í™”
            const allValid = Object.values(validationStatus).every(status => status === true);
            const passwordEntered = $('#password').val().trim() !== '';

            $('#submitButton').prop('disabled', !(allValid && passwordEntered));
        }

        // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì • (ì²˜ìŒì—ëŠ” ë¹„í™œì„±í™”)
        updateSubmitButtonStatus();

        // ê³µí†µ ì¤‘ë³µ í™•ì¸ í•¨ìˆ˜
        function checkDuplication(inputId, messageId, apiEndpoint, paramName, validationKey) {
            const $input = $('#' + inputId);
            const $message = $('#' + messageId);

            $input.on('blur', function() {
                const value = $input.val().trim();
                if (value === '') {
                    $message.text('í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.').removeClass('success-message').addClass('error-message'); // ë¹ˆ ê°’ì¼ ê²½ìš° ì˜¤ë¥˜ ë©”ì‹œì§€
                    validationStatus[validationKey] = false;
                    updateSubmitButtonStatus();
                    return;
                }

                $.ajax({
                    url: '/user/' + apiEndpoint, // UserControllerì˜ @RequestMapping("/user")ì™€ ê²°í•©
                    type: 'GET',
                    data: { [paramName]: value },
                    success: function(response) {
                        if (response.duplicated) {
                            $message.text('ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.').removeClass('success-message').addClass('error-message');
                            validationStatus[validationKey] = false;
                        } else {
                            $message.text('ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.').removeClass('error-message').addClass('success-message');
                            validationStatus[validationKey] = true;
                        }
                        updateSubmitButtonStatus();
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX Error: ", status, error);
                        $message.text('ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.').addClass('error-message');
                        validationStatus[validationKey] = false;
                        updateSubmitButtonStatus();
                    }
                });
            });

            // (ì„ íƒ ì‚¬í•­) ì…ë ¥ ì¤‘ì—ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì²´í¬í•˜ë ¤ë©´ 'keyup' ì´ë²¤íŠ¸ ì¶”ê°€
            $input.on('keyup', function() {
                 // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹œì—ë„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µë°±ì´ ì•„ë‹Œì§€ í™•ì¸)
                updateSubmitButtonStatus();
            });
        }

        // ê° í•„ë“œì— ëŒ€í•œ ì¤‘ë³µ í™•ì¸ ì„¤ì •
        checkDuplication('userId', 'userIdMessage', 'check/userId', 'userId', 'userId');
        checkDuplication('nickname', 'nicknameMessage', 'check/nickname', 'nickname', 'nickname');
        checkDuplication('email', 'emailMessage', 'check/email', 'email', 'email');
        checkDuplication('phone', 'phoneMessage', 'check/phone', 'phone', 'phone');
        // userCië„ UNIQUE ì œì•½ ì¡°ê±´ì´ ìˆë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œí•˜ì—¬ ì‚¬ìš©
        // checkDuplication('userCi', 'userCiMessage', 'check/userCi', 'userCi', 'userCi');

        // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        $('#password').on('keyup', updateSubmitButtonStatus);


        // â­ í”„ë¡œí•„ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ â­
        const $profileImageInput = $('#profileImageFile');
        const $profileImagePreview = $('#profileImagePreview');

        $profileImageInput.on('change', function(event) {
            const file = event.target.files[0]; // ì„ íƒëœ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
            if (file) {
                const reader = new FileReader(); // FileReader ê°ì²´ ìƒì„±
                reader.onload = function(e) {
                    $profileImagePreview.attr('src', e.target.result); // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ì˜ srcë¥¼ ì„ íƒëœ íŒŒì¼ì˜ ë°ì´í„° URLë¡œ ì„¤ì •
                    $profileImagePreview.show(); // ì´ë¯¸ì§€ë¥¼ ë³´ì´ê²Œ í•¨
                };
                reader.readAsDataURL(file); // íŒŒì¼ì„ Data URLë¡œ ì½ì–´ë“¤ì„
            } else {
                $profileImagePreview.attr('src', '/images/profile_upload/default_profile.jpg'); // íŒŒì¼ ì„ íƒ ì·¨ì†Œ ì‹œ ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë˜ëŒë¦¬ê¸°
            }
        });

        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ê°€ë¡œì±„ê¸° (ì„ íƒ ì‚¬í•­: jQuery serialize() ëŒ€ì‹  FormData ì‚¬ìš©)
        $('form').on('submit', function(event) {
            // í•„ìˆ˜ í•„ë“œê°€ ë¹„ì–´ìˆê±°ë‚˜, ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í†µê³¼í•˜ì§€ ëª»í•˜ë©´ ì œì¶œ ë°©ì§€
            const allFieldsValid = Object.values(validationStatus).every(status => status === true);
            const passwordEntered = $('#password').val().trim() !== '';

            if (!allFieldsValid || !passwordEntered) {
                alert("ëª¨ë“  í•„ìˆ˜ ì…ë ¥ í•„ë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.");
                event.preventDefault(); // í¼ ì œì¶œ ì¤‘ë‹¨
                return;
            }

            // AJAXë¡œ í¼ ë°ì´í„° ì „ì†¡
            event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë™ì‘ ë°©ì§€

            const $form = $(this);
            const formData = new FormData($form[0]); // jQuery ê°ì²´ì—ì„œ DOM ìš”ì†Œ ì¶”ì¶œ í›„ FormData ìƒì„±

            // CSRF í† í°ì„ FormDataì— ì¶”ê°€
            if (csrfParameterName && csrfToken) {
                formData.append(csrfParameterName, csrfToken);
            }

            $.ajax({
                url: $form.attr('action'), // í¼ì˜ action ì†ì„± ì‚¬ìš©
                type: $form.attr('method'), // í¼ì˜ method ì†ì„± ì‚¬ìš©
                data: formData,
                processData: false, // FormDataë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” false
                contentType: false, // FormDataë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” false
                success: function(response) {
                    // ì„œë²„ ì‘ë‹µì´ JSON í˜•ì‹ì´ë¼ê³  ê°€ì •
                    if (response.success) {
                        alert(response.message || 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                        window.location.href = '/user/login'; // Spring Security ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    } else {
                        alert('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + (response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX Submission Error: ", status, error, xhr.responseText);
                    const errorMessage = xhr.responseJSON ? xhr.responseJSON.message : 'ì„œë²„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    alert('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + errorMessage);
                }
            });
        });
    });
</script>
</body>
</html>